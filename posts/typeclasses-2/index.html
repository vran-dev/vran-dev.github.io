<!DOCTYPE html>
<html lang="en-us">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

		
		<meta name="google-site-verification" content="WQzn_X1rrhY2HHCuTYlY750m0YcuY3H73Z3T-OFsDOM" />
        

		<meta name="author" content="vran">
		
		<meta name="generator" content="Hugo 0.80.0" />
		<title>真的学不动了：Scala3 与 Type classes &middot; 且徐行</title>
		<link rel="shortcut icon" href="https://blog.cc1234.cc/images/favicon.ico">
        <link rel="stylesheet" href="https://blog.cc1234.cc/css/style.css">
        <link rel="stylesheet" href="https://blog.cc1234.cc/css/highlight.css">
</head>


<body>
    <section id="single" class="wrapper">
    <nav class="nav-main" style="display: flex;">
         <div style="margin-left:auto;">
            
            <a href='https://blog.cc1234.cc/'> Home</a>
            <a href='https://blog.cc1234.cc/posts'>Archive</a> 
            <a href='https://blog.cc1234.cc/tags'>Tags</a> 
            <a href='https://blog.cc1234.cc/about'>About</a>
   
           
         </div>
</nav>

        <article class = "post">
            <header>
                <div class = "post-img">
                    
                </div>
                <div class = "title" >
                    真的学不动了：Scala3 与 Type classes
                </div>
                <div class="meta">
                2020/07/19
                · vran
                </div>
            </header>
            <div class = "line"></div>
            
            <section class="content">
                <h2 id="引言">引言</h2>
<p>Type classes 源自 Haskell，在 Scala 中并没有直接的语法和概念，但却可以借助于强大的<strong>隐式系统</strong>间接实现，一般称之为 Type classes Pattern。</p>
<p>Type classes pattern 可谓是 Scala 中的屠龙技之一，然而这一招式随着 Scala3 的发布也产生了巨大的变化&hellip;&hellip;</p>
<blockquote>
<p>关于 Type classes 更多内容，可以参考 <a href="https://blog.cc1234.cc/posts/typeclasses-1/">《真的学不动了: 除了 class , 也该了解 Type classes 了》</a>。</p>
</blockquote>
<h2 id="回顾-scala2-与-type-classes">回顾 Scala2 与 Type classes</h2>
<p>Scala2 中 Type classes Pattern 有个固定的套路</p>
<ol>
<li>基于 trait 和泛型定义 Type class</li>
<li>实现 Type class 实例</li>
<li>定义包含<strong>隐式参数</strong>的函数</li>
</ol>
<p>下面用 Scala2 中的 Type classes Pattern 来改造一下经典的  <code>Comparator</code> 接口，相比于上一篇文章，这里的实现会多一些细节。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#a90d91">trait</span> <span style="color:#3f6e75">Comparator</span><span style="color:#000">[</span><span style="color:#a90d91">T</span><span style="color:#000">]</span> <span style="color:#000">{</span>
  <span style="color:#a90d91">def</span> <span style="color:#000">compare</span><span style="color:#000">(</span><span style="color:#000">a</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">T</span><span style="color:#000">,</span> <span style="color:#000">b</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">T</span><span style="color:#000">)</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Int</span>
<span style="color:#000">}</span>

<span style="color:#a90d91">object</span> <span style="color:#3f6e75">ComparatorInstances</span> <span style="color:#000">{</span>
  <span style="color:#a90d91">implicit</span> <span style="color:#a90d91">val</span> <span style="color:#000">intComparator</span> <span style="color:#a90d91">=</span> <span style="color:#a90d91">new</span> <span style="color:#3f6e75">Comparator</span><span style="color:#000">[</span><span style="color:#a90d91">Int</span><span style="color:#000">]</span> <span style="color:#000">{</span>
    <span style="color:#a90d91">override</span> <span style="color:#a90d91">def</span> <span style="color:#000">compare</span><span style="color:#000">(</span><span style="color:#000">a</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Int</span><span style="color:#000">,</span> <span style="color:#000">b</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Int</span><span style="color:#000">)</span> <span style="color:#a90d91">=</span> <span style="color:#000">a</span><span style="color:#000">.</span><span style="color:#000">compareTo</span><span style="color:#000">(</span><span style="color:#000">b</span><span style="color:#000">)</span>
  <span style="color:#000">}</span>
  
  <span style="color:#a90d91">implicit</span> <span style="color:#a90d91">def</span> <span style="color:#000">listComparator</span><span style="color:#000">[</span><span style="color:#a90d91">T</span><span style="color:#000">](</span><span style="color:#a90d91">implicit</span> <span style="color:#000">cmp</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Comparator</span><span style="color:#000">[</span><span style="color:#a90d91">T</span><span style="color:#000">])</span> <span style="color:#a90d91">=</span> <span style="color:#a90d91">new</span> <span style="color:#3f6e75">Comparator</span><span style="color:#000">[</span><span style="color:#a90d91">List</span><span style="color:#000">[</span><span style="color:#a90d91">T</span><span style="color:#000">]]</span> <span style="color:#000">{</span>
    <span style="color:#a90d91">override</span> <span style="color:#a90d91">def</span> <span style="color:#000">compare</span><span style="color:#000">(</span><span style="color:#000">a</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">List</span><span style="color:#000">[</span><span style="color:#a90d91">T</span><span style="color:#000">],</span> <span style="color:#000">b</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">List</span><span style="color:#000">[</span><span style="color:#a90d91">T</span><span style="color:#000">])</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Int</span> <span style="color:#000">=</span> <span style="color:#000">{</span>
      <span style="color:#000">(</span><span style="color:#000">a</span><span style="color:#000">,</span> <span style="color:#000">b</span><span style="color:#000">)</span> <span style="color:#a90d91">match</span> <span style="color:#000">{</span>
        <span style="color:#177500">// 两个都为空
</span><span style="color:#177500"></span>        <span style="color:#a90d91">case</span> <span style="color:#000">(</span><span style="color:#3f6e75">Nil</span><span style="color:#000">,</span> <span style="color:#3f6e75">Nil</span><span style="color:#000">)</span> <span style="color:#a90d91">=&gt;</span> <span style="color:#1c01ce">0</span>
        <span style="color:#177500">// 某一个为空
</span><span style="color:#177500"></span>        <span style="color:#a90d91">case</span> <span style="color:#000">(</span><span style="color:#3f6e75">Nil</span><span style="color:#000">,</span> <span style="color:#a90d91">_</span><span style="color:#000">)</span> <span style="color:#a90d91">=&gt;</span> <span style="color:#1c01ce">1</span>
        <span style="color:#a90d91">case</span> <span style="color:#000">(</span><span style="color:#a90d91">_</span><span style="color:#000">,</span> <span style="color:#3f6e75">Nil</span><span style="color:#000">)</span> <span style="color:#a90d91">=&gt;</span> <span style="color:#000">-</span><span style="color:#1c01ce">1</span>
        <span style="color:#177500">// 两个都不为空，
</span><span style="color:#177500"></span>        <span style="color:#a90d91">case</span> <span style="color:#000">(</span><span style="color:#000">l</span><span style="color:#000">,</span> <span style="color:#000">r</span><span style="color:#000">)</span> <span style="color:#a90d91">=&gt;</span>
          <span style="color:#177500">// 比较头结点
</span><span style="color:#177500"></span>          <span style="color:#000">cmp</span><span style="color:#000">.</span><span style="color:#000">compare</span><span style="color:#000">(</span><span style="color:#000">l</span><span style="color:#000">.</span><span style="color:#000">head</span><span style="color:#000">,</span> <span style="color:#000">r</span><span style="color:#000">.</span><span style="color:#000">head</span><span style="color:#000">)</span> <span style="color:#a90d91">match</span> <span style="color:#000">{</span>
            <span style="color:#177500">// List.tail 表示除了头结点以外的结点
</span><span style="color:#177500"></span>            <span style="color:#a90d91">case</span> <span style="color:#1c01ce">0</span> <span style="color:#a90d91">=&gt;</span> <span style="color:#000">compare</span><span style="color:#000">(</span><span style="color:#000">l</span><span style="color:#000">.</span><span style="color:#000">tail</span><span style="color:#000">,</span> <span style="color:#000">r</span><span style="color:#000">.</span><span style="color:#000">tail</span><span style="color:#000">)</span>
            <span style="color:#a90d91">case</span> <span style="color:#000">num</span> <span style="color:#a90d91">=&gt;</span> <span style="color:#000">num</span>
          <span style="color:#000">}</span>
      <span style="color:#000">}</span>
    <span style="color:#000">}</span>
  <span style="color:#000">}</span>
<span style="color:#000">}</span>

<span style="color:#a90d91">object</span> <span style="color:#3f6e75">Same</span> <span style="color:#000">{</span>
  <span style="color:#a90d91">def</span> <span style="color:#000">apply</span><span style="color:#000">[</span><span style="color:#a90d91">T</span><span style="color:#000">](</span><span style="color:#000">a</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">T</span><span style="color:#000">,</span> <span style="color:#000">b</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">T</span><span style="color:#000">)(</span><span style="color:#a90d91">implicit</span> <span style="color:#000">cmp</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Comparator</span><span style="color:#000">[</span><span style="color:#a90d91">T</span><span style="color:#000">])</span> <span style="color:#a90d91">=</span> <span style="color:#000">cmp</span><span style="color:#000">.</span><span style="color:#000">compare</span><span style="color:#000">(</span><span style="color:#000">a</span><span style="color:#000">,</span> <span style="color:#000">b</span><span style="color:#000">)</span> <span style="color:#000">==</span> <span style="color:#1c01ce">0</span>
<span style="color:#000">}</span>
</code></pre></div><p>稍微要说一下的就是  <code>listComparator</code>  这个函数了，这种用 <code>implicit def</code> 定义的方法一般称之为「隐式转换方法」。</p>
<p>隐式转换方法就是由编译器把参数的类型转换为返回值的类型（不需要显示的调用该方法）。</p>
<p>而   <code>listComparator</code>   函数的作用就是当你需要 Comparator[List[T]] 的实例时，编译器会在作用域内找到 Comparator[T] 的实例，然后将其转换为 Comparator[List[T]] 的实例。</p>
<p>如果没有这个方法</p>
<ul>
<li>处理 List[Int] 时需要定义一个 Comparator[List[Int]] 类型类实例</li>
<li>处理 List[String] 时需要定义一个 Comparator[List[String]]  类型类实例</li>
<li>&hellip;&hellip;</li>
</ul>
<p>有了该隐式方法以后</p>
<ul>
<li>处理 List[Int] 时，编译器会找到  Comparator[Int] 的实例， 然后根据该方法得到 Comparator[List[Int]] 实例进行处理</li>
<li>处理 List[String] 时， 编译器会找到  Comparator[String] 的实例， 然后根据该方法得到 Comparator[List[String]] 实例进行处理</li>
<li>&hellip;&hellip;</li>
</ul>
<p>其实最主要的作用就是在处理高阶类型时能复用已有的 Type class 实例。</p>
<p>最后再来测试一下， 调用前需要先将 Type class 实例都导入（正常的 import 语法）到作用域内</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#a90d91">import</span> <span style="color:#000">ComparatorInstances._</span>
<span style="color:#3f6e75">Same</span><span style="color:#000">(</span><span style="color:#1c01ce">1</span><span style="color:#000">,</span> <span style="color:#1c01ce">2</span><span style="color:#000">)</span>
<span style="color:#3f6e75">Same</span><span style="color:#000">(</span><span style="color:#3f6e75">List</span><span style="color:#000">(</span><span style="color:#1c01ce">1</span><span style="color:#000">,</span> <span style="color:#1c01ce">2</span><span style="color:#000">),</span> <span style="color:#3f6e75">List</span><span style="color:#000">(</span><span style="color:#1c01ce">1</span><span style="color:#000">,</span> <span style="color:#1c01ce">2</span><span style="color:#000">))</span>
</code></pre></div><p>在 Scala 中实现 type classes，很多时候还会使用<strong>函数扩展</strong>来简化调用，Scala 中的函数扩展是基于隐式类来实现的。</p>
<p>比如下面的代码就是在不修改 T 类型的情况下为 其扩展了 <code>&lt;</code> 、 <code>&gt;</code> 和 <code>isSameTo</code>  三个个函数</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#a90d91">object</span> <span style="color:#3f6e75">ComparatorInstances</span> <span style="color:#000">{</span>
  <span style="color:#177500">// ...
</span><span style="color:#177500"></span>
  <span style="color:#a90d91">implicit</span> <span style="color:#a90d91">class</span> <span style="color:#3f6e75">Ops</span><span style="color:#000">[</span><span style="color:#a90d91">T</span><span style="color:#000">](</span><span style="color:#000">a</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">T</span><span style="color:#000">)(</span><span style="color:#a90d91">implicit</span> <span style="color:#000">cmp</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Comparator</span><span style="color:#000">[</span><span style="color:#a90d91">T</span><span style="color:#000">])</span> <span style="color:#000">{</span>
    
    <span style="color:#a90d91">def</span> <span style="color:#000">isSameTo</span><span style="color:#000">(</span><span style="color:#000">b</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">T</span><span style="color:#000">)</span> <span style="color:#a90d91">=</span> <span style="color:#000">cmp</span><span style="color:#000">.</span><span style="color:#000">compare</span><span style="color:#000">(</span><span style="color:#000">a</span><span style="color:#000">,</span> <span style="color:#000">b</span><span style="color:#000">)</span> <span style="color:#000">==</span> <span style="color:#1c01ce">0</span>
    
    <span style="color:#a90d91">def</span> <span style="color:#000">&lt;(</span><span style="color:#000">b</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">T</span><span style="color:#000">)</span> <span style="color:#a90d91">=</span> <span style="color:#000">cmp</span><span style="color:#000">.</span><span style="color:#000">compare</span><span style="color:#000">(</span><span style="color:#000">a</span><span style="color:#000">,</span> <span style="color:#000">b</span><span style="color:#000">)</span> <span style="color:#000">&lt;</span> <span style="color:#1c01ce">0</span>

    <span style="color:#a90d91">def</span> <span style="color:#000">&gt;(</span><span style="color:#000">b</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">T</span><span style="color:#000">)</span> <span style="color:#a90d91">=</span> <span style="color:#000">cmp</span><span style="color:#000">.</span><span style="color:#000">compare</span><span style="color:#000">(</span><span style="color:#000">a</span><span style="color:#000">,</span> <span style="color:#000">b</span><span style="color:#000">)</span> <span style="color:#000">&gt;</span> <span style="color:#1c01ce">0</span>
  <span style="color:#000">}</span>

<span style="color:#000">}</span>
</code></pre></div><p>结合 Type classes Pattern 和函数扩展，使得调用更加自然（中缀式表示）</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#a90d91">import</span> <span style="color:#000">ComparatorInstances._</span>
<span style="color:#3f6e75">Same</span><span style="color:#000">(</span><span style="color:#3f6e75">List</span><span style="color:#000">(</span><span style="color:#1c01ce">1</span><span style="color:#000">,</span> <span style="color:#1c01ce">2</span><span style="color:#000">),</span> <span style="color:#3f6e75">List</span><span style="color:#000">(</span><span style="color:#1c01ce">1</span><span style="color:#000">,</span> <span style="color:#1c01ce">2</span><span style="color:#000">))</span>
<span style="color:#177500">// 函数扩展为 List 扩展了 &lt; 函数
</span><span style="color:#177500"></span><span style="color:#3f6e75">List</span><span style="color:#000">(</span><span style="color:#1c01ce">1</span><span style="color:#000">,</span><span style="color:#1c01ce">2</span><span style="color:#000">).&lt;(</span><span style="color:#3f6e75">List</span><span style="color:#000">(</span><span style="color:#1c01ce">1</span><span style="color:#000">,</span> <span style="color:#1c01ce">3</span><span style="color:#000">))</span>
<span style="color:#177500">// 也可以省略 . 和参数括号
</span><span style="color:#177500"></span><span style="color:#3f6e75">List</span><span style="color:#000">(</span><span style="color:#1c01ce">1</span><span style="color:#000">,</span> <span style="color:#1c01ce">2</span><span style="color:#000">)</span> <span style="color:#000">&lt;</span> <span style="color:#3f6e75">List</span><span style="color:#000">(</span><span style="color:#1c01ce">1</span><span style="color:#000">,</span> <span style="color:#1c01ce">3</span><span style="color:#000">)</span>
<span style="color:#177500">// 函数扩展
</span><span style="color:#177500"></span><span style="color:#3f6e75">List</span><span style="color:#000">(</span><span style="color:#1c01ce">1</span><span style="color:#000">,</span><span style="color:#1c01ce">2</span><span style="color:#000">).</span><span style="color:#000">isSameTo</span><span style="color:#000">(</span><span style="color:#3f6e75">List</span><span style="color:#000">(</span><span style="color:#1c01ce">2</span><span style="color:#000">,</span> <span style="color:#1c01ce">3</span><span style="color:#000">))</span>
<span style="color:#3f6e75">List</span><span style="color:#000">(</span><span style="color:#1c01ce">1</span><span style="color:#000">,</span> <span style="color:#1c01ce">2</span><span style="color:#000">)</span> <span style="color:#000">isSameTo</span> <span style="color:#3f6e75">List</span><span style="color:#000">(</span><span style="color:#1c01ce">2</span><span style="color:#000">,</span> <span style="color:#1c01ce">3</span><span style="color:#000">)</span>

</code></pre></div><p>虽然借助于隐式系统实现了 Type classes, 但还是有刺可以挑的</p>
<ul>
<li>
<p>语言层面的支持不友好</p>
<p>引入了晦涩的隐式转换等概念，而这也是导致 Scala 的 Type classes 难以掌握的原因之一。</p>
<p>难道就不能有更友好的语法支持吗？</p>
</li>
<li>
<p>实例导入冲突</p>
<p>我明明只是导入了某些依赖，但这个依赖里面却有 type class 实例，它覆盖了我期望调用的实例，造成了非常隐秘的 BUG。</p>
<p>（从另一个角度来说，这个<strong>实例可覆盖</strong>又是一个灵活性的体现）</p>
<p>难道就不能区分普通的 import 和 type class 实例的 import 吗？</p>
</li>
</ul>
<blockquote>
<p>对于使用隐式系统实现 Type classes 的缺点，还可以参考  《<a href="https://www.adelbertc.com/publications/typeclasses-scala17.pdf">The Limitations of Type Classes as Subtyped Implicits》</a></p>
</blockquote>
<h2 id="探秘-scala3-与-type-classes">探秘 Scala3 与 Type classes</h2>
<p>在 Scala 2 中，隐式系统是造成  Type classes Pattern 难以掌握的原因之一。</p>
<p>而在  Scala3 中，将再也不用为 纠结 implicit 该怎么用了， 它被全新的 <code>Given</code>、<code>Using</code> 、<code>Extension Method</code> 等特性所替代。</p>
<blockquote>
<p>要使用 Scala3 的语法的话，需要到 <a href="https://dotty.epfl.ch/">https://dotty.epfl.ch/</a> 下载 Dotty 编译器</p>
</blockquote>
<p><img src="img/dotty.jpg" alt="dotty"></p>
<p>Talk is Cheap，我们用 Scala3 的语法再次改造一遍 Comparator 。</p>
<h3 id="given-与-type-class-实例">Given 与 Type class 实例</h3>
<p>首先是 Type class 的定义，这一块和以前没有区别，还是基于 trait 和泛型。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#a90d91">trait</span> <span style="color:#3f6e75">Comparator</span><span style="color:#000">[</span><span style="color:#a90d91">T</span><span style="color:#000">]</span> <span style="color:#000">{</span>
  <span style="color:#a90d91">def</span> <span style="color:#000">compare</span><span style="color:#000">[</span><span style="color:#a90d91">T</span><span style="color:#000">](</span><span style="color:#000">a</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">T</span><span style="color:#000">,</span> <span style="color:#000">b</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">T</span><span style="color:#000">)</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Int</span>
<span style="color:#000">}</span>
</code></pre></div><p>然后就是实现 Type class 实例了，用全新的语法 <code>given...as</code> 来实现。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#000">given</span> <span style="color:#000">intCompare</span> <span style="color:#000">as</span> <span style="color:#3f6e75">Comparator</span><span style="color:#000">[</span><span style="color:#a90d91">Int</span><span style="color:#000">]</span> <span style="color:#000">{</span>
  <span style="color:#a90d91">override</span> <span style="color:#a90d91">def</span> <span style="color:#000">compare</span><span style="color:#000">(</span><span style="color:#000">a</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Int</span><span style="color:#000">,</span> <span style="color:#000">b</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Int</span><span style="color:#000">)</span> <span style="color:#a90d91">=</span> <span style="color:#000">a</span><span style="color:#000">.</span><span style="color:#000">compareTo</span><span style="color:#000">(</span><span style="color:#000">b</span><span style="color:#000">)</span>
<span style="color:#000">}</span>
</code></pre></div><p>given 后面跟实例名称， as 可以指定类型，实际体验和「匿名类」的构造很相似。</p>
<p>given 支持命名构造和匿名构造，当使用匿名构造时编译器会为实例自动生成一个可读的名称，下面展示了具体的代码：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#a90d91">object</span> <span style="color:#3f6e75">ComparatorInstances</span> <span style="color:#000">{</span>

  <span style="color:#177500">// 命名构造
</span><span style="color:#177500"></span>  <span style="color:#000">given</span> <span style="color:#000">intComparator</span> <span style="color:#000">as</span>  <span style="color:#3f6e75">Comparator</span><span style="color:#000">[</span><span style="color:#a90d91">Int</span><span style="color:#000">]</span> <span style="color:#000">{</span>
    <span style="color:#a90d91">override</span> <span style="color:#a90d91">def</span> <span style="color:#000">compare</span><span style="color:#000">(</span><span style="color:#000">a</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Int</span><span style="color:#000">,</span> <span style="color:#000">b</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Int</span><span style="color:#000">)</span> <span style="color:#a90d91">=</span> <span style="color:#000">a</span><span style="color:#000">.</span><span style="color:#000">compareTo</span><span style="color:#000">(</span><span style="color:#000">b</span><span style="color:#000">)</span>
  <span style="color:#000">}</span>
  
  <span style="color:#177500">// 匿名构造 自动生成可读的实例名称： given_Comparator_String
</span><span style="color:#177500"></span>  <span style="color:#000">given</span> <span style="color:#3f6e75">Comparator</span><span style="color:#000">[</span><span style="color:#a90d91">String</span><span style="color:#000">]</span> <span style="color:#000">{</span>
    <span style="color:#a90d91">override</span> <span style="color:#a90d91">def</span> <span style="color:#000">compare</span><span style="color:#000">(</span><span style="color:#000">a</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">String</span><span style="color:#000">,</span> <span style="color:#000">b</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">String</span><span style="color:#000">)</span> <span style="color:#a90d91">=</span> <span style="color:#000">a</span><span style="color:#000">.</span><span style="color:#000">compareTo</span><span style="color:#000">(</span><span style="color:#000">b</span><span style="color:#000">)</span> 
  <span style="color:#000">}</span>

  <span style="color:#177500">// 高阶函数命名构造
</span><span style="color:#177500"></span>  <span style="color:#000">given</span> <span style="color:#000">doubleComparator</span> <span style="color:#000">as</span> <span style="color:#3f6e75">Comparator</span><span style="color:#000">[</span><span style="color:#a90d91">Double</span><span style="color:#000">]</span> <span style="color:#a90d91">=</span> <span style="color:#000">instance</span><span style="color:#000">[</span><span style="color:#a90d91">Double</span><span style="color:#000">]((</span><span style="color:#000">a</span><span style="color:#000">,</span> <span style="color:#000">b</span><span style="color:#000">)</span> <span style="color:#a90d91">=&gt;</span> <span style="color:#000">a</span><span style="color:#000">.</span><span style="color:#000">compareTo</span><span style="color:#000">(</span><span style="color:#000">b</span><span style="color:#000">))</span>
  
  <span style="color:#177500">// 高阶函数匿名构造
</span><span style="color:#177500"></span>  <span style="color:#000">given</span> <span style="color:#3f6e75">Comparator</span><span style="color:#000">[</span><span style="color:#a90d91">Float</span><span style="color:#000">]</span> <span style="color:#a90d91">=</span> <span style="color:#000">instance</span><span style="color:#000">[</span><span style="color:#a90d91">Float</span><span style="color:#000">]((</span><span style="color:#000">a</span><span style="color:#000">,</span> <span style="color:#000">b</span><span style="color:#000">)</span> <span style="color:#a90d91">=&gt;</span> <span style="color:#000">a</span><span style="color:#000">.</span><span style="color:#000">compareTo</span><span style="color:#000">(</span><span style="color:#000">b</span><span style="color:#000">))</span>
  
  <span style="color:#a90d91">private</span> <span style="color:#a90d91">def</span> <span style="color:#000">instance</span><span style="color:#000">[</span><span style="color:#a90d91">T</span><span style="color:#000">](</span><span style="color:#000">func</span><span style="color:#a90d91">:</span> <span style="color:#000">(</span><span style="color:#a90d91">T</span><span style="color:#000">,</span> <span style="color:#a90d91">T</span><span style="color:#000">)</span> <span style="color:#a90d91">=&gt;</span> <span style="color:#3f6e75">Int</span><span style="color:#000">)</span> <span style="color:#a90d91">=</span> <span style="color:#a90d91">new</span> <span style="color:#3f6e75">Comparator</span><span style="color:#000">[</span><span style="color:#a90d91">T</span><span style="color:#000">]</span> <span style="color:#000">{</span>
    <span style="color:#a90d91">override</span> <span style="color:#a90d91">def</span> <span style="color:#000">compare</span><span style="color:#000">(</span><span style="color:#000">a</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">T</span><span style="color:#000">,</span> <span style="color:#000">b</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">T</span><span style="color:#000">)</span> <span style="color:#a90d91">=</span> <span style="color:#000">func</span><span style="color:#000">(</span><span style="color:#000">a</span><span style="color:#000">,</span> <span style="color:#000">b</span><span style="color:#000">)</span>
  <span style="color:#000">}</span>
<span style="color:#000">}</span>
</code></pre></div><h3 id="using-与-given">Using 与 Given</h3>
<p>前面通过 <code>given</code> 实现了类型类实例，可是什么时候使用这些实例呢？</p>
<p>这就轮到好基友 <code>using</code> 出场 了， <code>using</code>  用于修饰参数。</p>
<p>被 using 修饰的参数称之为<strong>上下文参数</strong>，该参数可以不用手动传入，编译器会在作用域内寻找匹配的 given 实例传入（类似于 Scala2 的隐式参数）。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#a90d91">object</span> <span style="color:#3f6e75">Same</span> <span style="color:#000">{</span>
  <span style="color:#177500">// 命名上下文参数
</span><span style="color:#177500"></span>  <span style="color:#a90d91">def</span> <span style="color:#000">apply</span><span style="color:#000">[</span><span style="color:#a90d91">T</span><span style="color:#000">](</span><span style="color:#000">a</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">T</span><span style="color:#000">,</span> <span style="color:#000">b</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">T</span><span style="color:#000">)(</span><span style="color:#000">using</span> <span style="color:#000">cmp</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Comparator</span><span style="color:#000">[</span><span style="color:#a90d91">T</span><span style="color:#000">])</span> <span style="color:#a90d91">=</span> <span style="color:#000">cmp</span><span style="color:#000">.</span><span style="color:#000">compare</span><span style="color:#000">(</span><span style="color:#000">a</span><span style="color:#000">,</span> <span style="color:#000">b</span><span style="color:#000">)</span> <span style="color:#000">==</span> <span style="color:#1c01ce">0</span>
<span style="color:#000">}</span>
</code></pre></div><h3 id="given-import">Given Import</h3>
<p>前面提到『编译器会在作用域自动寻找匹配的 given 实例』，在 Scala2 以前主要是通过 Import 导入，也就是 <code>import ComparatorInstances._</code> 。</p>
<p>在 Scala3 中即使这样导入了，编译仍然报错：提示找不到对应的实例。</p>
<p>这是因为针对 given 实例的导入也有了单独的语法，特意用于区分普通的依赖导入。</p>
<p>Scala3 中，given 实例的导入称之为  `given import， 它的语法也很简单</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#177500">// 导入单个实例
</span><span style="color:#177500"></span><span style="color:#a90d91">import</span> <span style="color:#000">xxx.</span><span style="color:#000">{</span><span style="color:#000">given</span> <span style="color:#000">aInstance</span><span style="color:#000">}</span>
<span style="color:#177500">// 通配符 导入所有实例
</span><span style="color:#177500"></span><span style="color:#a90d91">import</span> <span style="color:#000">xxx.</span><span style="color:#000">{</span><span style="color:#000">given</span> <span style="color:#a90d91">_</span><span style="color:#000">}</span>
</code></pre></div><p>通过 ComparatorInstances 验证一下</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#177500">// 导入所有 given 实例就用占位符 _
</span><span style="color:#177500">// 也可以只导入某一个实例
</span><span style="color:#177500"></span><span style="color:#a90d91">import</span> <span style="color:#000">ComparatorInstances.</span><span style="color:#000">{</span><span style="color:#000">given</span> <span style="color:#a90d91">_</span><span style="color:#000">}</span>

<span style="color:#3f6e75">Same</span><span style="color:#000">(</span><span style="color:#1c01ce">1</span><span style="color:#000">,</span> <span style="color:#1c01ce">2</span><span style="color:#000">)</span>
<span style="color:#3f6e75">Same</span><span style="color:#000">(</span><span style="color:#1c01ce">1.2F</span><span style="color:#000">,</span> <span style="color:#1c01ce">2.2F</span><span style="color:#000">)</span>
<span style="color:#3f6e75">Same</span><span style="color:#000">(</span><span style="color:#1c01ce">1.2D</span><span style="color:#000">,</span> <span style="color:#1c01ce">2.2D</span><span style="color:#000">)</span>
<span style="color:#3f6e75">Same</span><span style="color:#000">(</span><span style="color:#c41a16">&#34;ok&#34;</span><span style="color:#000">,</span> <span style="color:#c41a16">&#34;ok&#34;</span><span style="color:#000">)</span>

</code></pre></div><p>这样，一个  Scala3 版的 Type classes Pattern 就完成了，一个 implicit 也看不见了。</p>
<p>相较于 Scala2 版，并没有减少多少代码量，但更直接的语法支持却是大大增强了可读性。</p>
<p>下面是自创的一个新版 Type classes Pattern「记忆语法」</p>
<blockquote>
<p>[使用]编译器在[作用域内]找到的[给定实例]</p>
<p>[using]&hellip;&hellip;&hellip;&hellip;.[given import]&hellip;&hellip;[given instance]</p>
</blockquote>
<h3 id="extension-method">Extension Method</h3>
<p>在 Scala2 中要实现<strong>函数扩展</strong>得基于 <code>implicit class</code>，但是光看名字很难将这两者关联起来。</p>
<p>好在 Scala3 也注意到了这个问题，索性就之间新增了一个<code>extension method</code> 的特性，实际就是<strong>函数扩展</strong>。</p>
<p><code>Extension method</code>  是一种新的<strong>函数定义语法</strong>（忘记 implicit class 吧），参考下面的代码</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#a90d91">trait</span> <span style="color:#3f6e75">Comparator</span><span style="color:#000">[</span><span style="color:#a90d91">T</span><span style="color:#000">]</span> <span style="color:#000">{</span>
  <span style="color:#a90d91">def</span> <span style="color:#000">compare</span><span style="color:#000">[</span><span style="color:#a90d91">T</span><span style="color:#000">](</span><span style="color:#000">a</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">T</span><span style="color:#000">,</span> <span style="color:#000">b</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">T</span><span style="color:#000">)</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Int</span>
  
  <span style="color:#a90d91">def</span> <span style="color:#000">(</span><span style="color:#000">a</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">T</span><span style="color:#000">)</span> <span style="color:#000">&gt;(</span><span style="color:#000">b</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">T</span><span style="color:#000">)</span> <span style="color:#a90d91">=</span> <span style="color:#000">compare</span><span style="color:#000">(</span><span style="color:#000">a</span><span style="color:#000">,</span> <span style="color:#000">b</span><span style="color:#000">)</span> <span style="color:#000">&gt;</span> <span style="color:#1c01ce">0</span>
  <span style="color:#a90d91">def</span> <span style="color:#000">(</span><span style="color:#000">a</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">T</span><span style="color:#000">)</span> <span style="color:#000">&lt;(</span><span style="color:#000">b</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">T</span><span style="color:#000">)</span> <span style="color:#a90d91">=</span> <span style="color:#000">compare</span><span style="color:#000">(</span><span style="color:#000">a</span><span style="color:#000">,</span> <span style="color:#000">b</span><span style="color:#000">)</span> <span style="color:#000">&lt;</span> <span style="color:#1c01ce">0</span>
<span style="color:#000">}</span>
</code></pre></div><p><code>&gt;</code> 和 <code>&lt;</code> 就是全新的函数扩展语法</p>
<ul>
<li><code>a: T</code> 就是需要扩展函数的类型</li>
<li><code>b: T</code> 就是函数的实际参数</li>
</ul>
<p>假设 T 为 String 类型，那么我们就可以直接写出下面的中缀式调用语法</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#177500">// 为字符串扩展了 &gt; 函数
</span><span style="color:#177500"></span><span style="color:#c41a16">&#34;ok&#34;</span><span style="color:#000">.&gt;(</span><span style="color:#c41a16">&#34;hello&#34;</span><span style="color:#000">)</span>

<span style="color:#177500">// 也可以省略 . 和括号
</span><span style="color:#177500"></span><span style="color:#c41a16">&#34;ok&#34;</span>  <span style="color:#000">&gt;</span> <span style="color:#c41a16">&#34;hello&#34;</span>
</code></pre></div><p>除了为类型扩展函数外，该语法也可以实现 Scala2 的隐式方法的功能。</p>
<p>我们将 Scala2 中 <code>implicit def listComparator</code> 实例用 <code>extension method</code> 的语法再实现一遍（还需要借助 using）</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#a90d91">object</span> <span style="color:#3f6e75">ComparatorInstances</span> <span style="color:#000">{</span>
  
  <span style="color:#177500">// ......
</span><span style="color:#177500"></span>  
  <span style="color:#a90d91">def</span> <span style="color:#000">[</span><span style="color:#a90d91">T</span><span style="color:#000">](</span><span style="color:#000">a</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">List</span><span style="color:#000">[</span><span style="color:#a90d91">T</span><span style="color:#000">])</span> <span style="color:#000">listInstance</span><span style="color:#000">(</span><span style="color:#000">using</span> <span style="color:#000">cmp</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Comparator</span><span style="color:#000">[</span><span style="color:#a90d91">T</span><span style="color:#000">])</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Comparator</span><span style="color:#000">[</span><span style="color:#a90d91">List</span><span style="color:#000">[</span><span style="color:#a90d91">T</span><span style="color:#000">]]</span> <span style="color:#a90d91">=</span> <span style="color:#a90d91">new</span> <span style="color:#3f6e75">Comparator</span><span style="color:#000">[</span><span style="color:#a90d91">List</span><span style="color:#000">[</span><span style="color:#a90d91">T</span><span style="color:#000">]]</span> <span style="color:#000">{</span>
    <span style="color:#a90d91">override</span> <span style="color:#a90d91">def</span> <span style="color:#000">compare</span><span style="color:#000">(</span><span style="color:#000">a</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">List</span><span style="color:#000">[</span><span style="color:#a90d91">T</span><span style="color:#000">],</span> <span style="color:#000">b</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">List</span><span style="color:#000">[</span><span style="color:#a90d91">T</span><span style="color:#000">])</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Int</span> <span style="color:#000">=</span> <span style="color:#000">{</span>
      <span style="color:#000">(</span><span style="color:#000">a</span><span style="color:#000">,</span> <span style="color:#000">b</span><span style="color:#000">)</span> <span style="color:#a90d91">match</span> <span style="color:#000">{</span>
        <span style="color:#a90d91">case</span> <span style="color:#000">(</span><span style="color:#3f6e75">Nil</span><span style="color:#000">,</span> <span style="color:#3f6e75">Nil</span><span style="color:#000">)</span> <span style="color:#a90d91">=&gt;</span> <span style="color:#1c01ce">0</span>
        <span style="color:#a90d91">case</span> <span style="color:#000">(</span><span style="color:#3f6e75">Nil</span><span style="color:#000">,</span> <span style="color:#a90d91">_</span><span style="color:#000">)</span> <span style="color:#a90d91">=&gt;</span> <span style="color:#1c01ce">1</span>
        <span style="color:#a90d91">case</span> <span style="color:#000">(</span><span style="color:#a90d91">_</span><span style="color:#000">,</span> <span style="color:#3f6e75">Nil</span><span style="color:#000">)</span> <span style="color:#a90d91">=&gt;</span> <span style="color:#000">-</span><span style="color:#1c01ce">1</span>
        <span style="color:#a90d91">case</span> <span style="color:#000">(</span><span style="color:#000">l</span><span style="color:#000">,</span> <span style="color:#000">r</span><span style="color:#000">)</span> <span style="color:#a90d91">=&gt;</span>
          <span style="color:#000">cmp</span><span style="color:#000">.</span><span style="color:#000">compare</span><span style="color:#000">(</span><span style="color:#000">l</span><span style="color:#000">.</span><span style="color:#000">head</span><span style="color:#000">,</span> <span style="color:#000">r</span><span style="color:#000">.</span><span style="color:#000">head</span><span style="color:#000">)</span> <span style="color:#a90d91">match</span> <span style="color:#000">{</span>
            <span style="color:#a90d91">case</span> <span style="color:#1c01ce">0</span> <span style="color:#a90d91">=&gt;</span> <span style="color:#000">compare</span><span style="color:#000">(</span><span style="color:#000">l</span><span style="color:#000">.</span><span style="color:#000">tail</span><span style="color:#000">,</span> <span style="color:#000">r</span><span style="color:#000">.</span><span style="color:#000">tail</span><span style="color:#000">)</span>
            <span style="color:#a90d91">case</span> <span style="color:#000">num</span> <span style="color:#a90d91">=&gt;</span> <span style="color:#000">num</span>
          <span style="color:#000">}</span>
      <span style="color:#000">}</span>
    <span style="color:#000">}</span>
  <span style="color:#000">}</span>
<span style="color:#000">}</span>
</code></pre></div><h3 id="旧瓶装新酒">旧瓶装新酒？</h3>
<p>如果你已经跨过了隐式系统那道门槛，这样的语法改变可能并不会给你带来多大的惊喜，感觉就像旧瓶装新酒一样，似乎没多大的新意？</p>
<p>而在我看来这样的「旧瓶装新酒」却是 Scala 提升亲和力的体现，当然 Scala3 也不止这些改变，更多特性可以参考 <a href="https://dotty.epfl.ch/docs/reference/overview.html">https://dotty.epfl.ch/docs/reference/overview.html</a>。</p>
<h2 id="比较-scala2-与-scala3">比较 Scala2 与 Scala3</h2>
<p><code>given</code>、<code>using</code>、<code>extension method</code>  等特性在 Scala3 被统一称之为<strong>抽象上下文</strong>（Contextual Abstractions），前面已经或多或少拿它们与  Scala2 的隐式系统做过参照了。</p>
<p>不过这里还是打算单独拿出来对比一下，就相当于一个简单的总结吧。</p>
<p>1、 <code>given</code> 可以当做无参的 <code>implicit object</code> 或 <code>implicit val</code></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#000">given</span> <span style="color:#000">intComparator</span> <span style="color:#000">as</span> <span style="color:#3f6e75">Comparator</span><span style="color:#000">[</span><span style="color:#a90d91">INT</span><span style="color:#000">]</span> <span style="color:#000">{</span> <span style="color:#000">...</span> <span style="color:#000">}</span>
</code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#a90d91">implicit</span> <span style="color:#a90d91">object</span> <span style="color:#3f6e75">intComparator</span> <span style="color:#3f6e75">Comparator</span> <span style="color:#3f6e75">Ord</span><span style="color:#000">[</span><span style="color:#a90d91">Int</span><span style="color:#000">]</span> <span style="color:#000">{</span> <span style="color:#000">...</span> <span style="color:#000">}</span>

<span style="color:#a90d91">implicit</span> <span style="color:#a90d91">val</span> <span style="color:#000">intComparator</span> <span style="color:#a90d91">=</span> <span style="color:#a90d91">new</span> <span style="color:#3f6e75">Comparator</span><span style="color:#000">[</span><span style="color:#a90d91">Int</span><span style="color:#000">]</span> <span style="color:#000">{</span> <span style="color:#000">...</span> <span style="color:#000">}</span>
</code></pre></div><p>2、using 可以当做以前的<strong>隐式参数</strong></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#a90d91">def</span> <span style="color:#000">same</span><span style="color:#000">[</span><span style="color:#a90d91">T</span><span style="color:#000">](</span><span style="color:#000">a</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">T</span><span style="color:#000">,</span> <span style="color:#000">b</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">T</span><span style="color:#000">)(</span><span style="color:#000">using</span> <span style="color:#000">cmp</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Comparator</span><span style="color:#000">[</span><span style="color:#a90d91">T</span><span style="color:#000">])</span> <span style="color:#000">{...}</span>
</code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#a90d91">def</span> <span style="color:#000">same</span><span style="color:#000">[</span><span style="color:#a90d91">T</span><span style="color:#000">](</span><span style="color:#000">a</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">T</span><span style="color:#000">,</span> <span style="color:#000">b</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">T</span><span style="color:#000">)(</span><span style="color:#a90d91">implicit</span> <span style="color:#000">cmp</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Comparator</span><span style="color:#000">[</span><span style="color:#a90d91">T</span><span style="color:#000">])</span> <span style="color:#000">{...}</span>
</code></pre></div><p>3、extension method 可以当做以前的<strong>隐式类</strong></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#a90d91">trait</span> <span style="color:#3f6e75">Comparator</span><span style="color:#000">[</span><span style="color:#a90d91">T</span><span style="color:#000">]</span> <span style="color:#000">{</span>
  <span style="color:#a90d91">def</span> <span style="color:#000">compare</span><span style="color:#000">(</span><span style="color:#000">a</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">T</span><span style="color:#000">,</span> <span style="color:#000">b</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">T</span><span style="color:#000">)</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Int</span>

  <span style="color:#a90d91">def</span> <span style="color:#000">(</span><span style="color:#000">a</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">T</span><span style="color:#000">)</span> <span style="color:#000">&gt;(</span><span style="color:#000">b</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">T</span><span style="color:#000">)</span> <span style="color:#a90d91">=</span> <span style="color:#000">compare</span><span style="color:#000">(</span><span style="color:#000">a</span><span style="color:#000">,</span> <span style="color:#000">b</span><span style="color:#000">)</span> <span style="color:#000">&gt;</span> <span style="color:#1c01ce">0</span>
  <span style="color:#a90d91">def</span> <span style="color:#000">(</span><span style="color:#000">a</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">T</span><span style="color:#000">)</span> <span style="color:#000">&lt;(</span><span style="color:#000">b</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">T</span><span style="color:#000">)</span> <span style="color:#a90d91">=</span> <span style="color:#000">compare</span><span style="color:#000">(</span><span style="color:#000">a</span><span style="color:#000">,</span> <span style="color:#000">b</span><span style="color:#000">)</span> <span style="color:#000">&lt;</span> <span style="color:#1c01ce">0</span>
<span style="color:#000">}</span>
</code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#a90d91">implicit</span> <span style="color:#a90d91">class</span> <span style="color:#3f6e75">ComparatorOps</span><span style="color:#000">[</span><span style="color:#a90d91">T</span><span style="color:#000">](</span><span style="color:#000">a</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">T</span><span style="color:#000">)(</span><span style="color:#a90d91">implicit</span> <span style="color:#000">cmp</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Comparator</span><span style="color:#000">[</span><span style="color:#a90d91">T</span><span style="color:#000">])</span> <span style="color:#000">{</span>
    <span style="color:#a90d91">def</span> <span style="color:#000">&lt;(</span><span style="color:#000">b</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">T</span><span style="color:#000">)</span> <span style="color:#a90d91">=</span> <span style="color:#000">cmp</span><span style="color:#000">.</span><span style="color:#000">compare</span><span style="color:#000">(</span><span style="color:#000">a</span><span style="color:#000">,</span> <span style="color:#000">b</span><span style="color:#000">)</span> <span style="color:#000">&lt;</span> <span style="color:#1c01ce">0</span>

    <span style="color:#a90d91">def</span> <span style="color:#000">&gt;(</span><span style="color:#000">b</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">T</span><span style="color:#000">)</span> <span style="color:#a90d91">=</span> <span style="color:#000">cmp</span><span style="color:#000">.</span><span style="color:#000">compare</span><span style="color:#000">(</span><span style="color:#000">a</span><span style="color:#000">,</span> <span style="color:#000">b</span><span style="color:#000">)</span> <span style="color:#000">&gt;</span> <span style="color:#1c01ce">0</span>
<span style="color:#000">}</span>
</code></pre></div><h2 id="一些期待">一些期待</h2>
<p>开发者们一直喜欢拿 Scala 和 Haskell、Java 作比较，甚至在对应社区一直有这样的声音</p>
<ul>
<li>A worse Haskell for the JVM</li>
<li>A better Java</li>
</ul>
<p>造成这些印象的原因是 Scala 融合了 OOP 和 FP 两种编程范式，但这也恰好是 Scala 一直坚持的方向。</p>
<p>随着 Scala3 的发布，是不是会带来不一样的惊喜呢？有点期待</p>
<h2 id="参考">参考</h2>
<ol>
<li><a href="https://dotty.epfl.ch/">Dotty: A next-generation compiler for Scala</a></li>
<li><a href="https://www.adelbertc.com/publications/typeclasses-scala17.pdf">The Limitations of Type Classes as Subtyped Implicits</a></li>
<li><a href="https://medium.com/se-notes-by-alexey-novakov/scala-type-classes-comparison-28b76ce1f37a">Scala Type Classes comparison</a></li>
<li><a href="https://blog.cc1234.cc/posts/typeclasses-1/">真的学不动了: 除了 class , 也该了解 Type classes 了</a></li>
<li><a href="https://www.slidestalk.com/u39/preparing_for_scala_3_light_bend_vsjjhm">preparing_for_scala_3_PPT</a></li>
</ol>

            </section>

            <div class="over">
                <div class="line"></div>
                <span>over</span>
                <div class="line"></div>
            </div>
        </article>
        <div class = "social">

    
        <a href="https://github.com/vran-dev">
            <svg t="1612751476854" class="social-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="9196" width="22" height="22">
                <path d="M63.681087 516.285293c0 210.288698 144.593659 387.06044 340.109608 435.411104 8.963443 2.334559 18.979018-5.66029 18.685506-14.948855V740.533933c0-9.954615 5.899616-19.5096 16.818309-25.228593 11.097059-5.5474 8.380932-25.607902-3.738907-28.030515-56.790299-11.356705-105.233532-34.160427-139.233656-64.471315-33.930132-30.367333-53.245562-67.216792-53.245561-106.518217 0-27.359951 9.783022-53.611324 27.084499-77.566521a14.623733 14.623733 0 0 0 2.817728-8.365127v-142.999656l118.721594 63.536587c3.619244 1.971054 8.143864 2.291661 12.088231 0.889571 33.284403-9.868819 69.433946-14.890153 108.385412-14.890153 38.949208 0 75.096494 5.021334 108.385413 14.948856a15.36429 15.36429 0 0 0 12.146933-0.891829l118.662892-63.59529v142.91386a15.115932 15.115932 0 0 0 2.801922 8.42383c17.346633 23.925846 27.098046 50.235922 27.098047 77.564263 0 39.333033-19.268016 76.180235-53.200406 106.547568-34.043022 30.310888-82.5427 53.083-139.278811 64.471315-12.115324 2.363911-14.77049 22.42667-3.73665 27.971813 10.923209 5.723508 16.822825 15.240111 16.822825 25.23085v196.215867c-0.295771 9.28405 9.749156 17.281157 18.685505 14.948855C816.104564 903.343476 960.668872 726.517546 960.668872 516.285293c0-247.50392-201.00239-448.495021-448.492764-448.495021-247.50392 0-448.495021 200.991101-448.495021 448.495021z m448.495021-418.595052c231.37198 0 418.590537 187.236619 418.590537 418.595052 0 189.266376-126.779662 345.246091-298.995176 397.046664v-172.800282c0-11.970825-4.610416-22.60052-11.209949-31.769422 49.723403-13.666429 95.127645-35.156114 127.946942-64.471315 38.922115-34.600697 62.660564-78.952807 62.660564-128.005645 0-32.381285-11.794717-62.003545-29.897711-88.808078v-165.336015c0.085796-10.469392-13.314213-18.322-22.428928-13.068113l-137.34614 73.755365c-34.108498-9.254699-70.578648-15.840684-109.320139-15.840685-38.718913 0-75.277118 6.525025-109.322397 15.840685l-137.352913-73.726013c-9.094395-5.253887-22.510209 2.598721-22.424412 13.068113v165.336014c-18.116541 26.806791-29.899969 56.429051-29.899969 88.808079 0 49.025744 23.7678 93.375596 62.617665 127.978551 32.878 29.373903 78.32514 50.804886 127.962747 64.532275-6.572439 9.137293-11.185113 19.737637-11.185113 31.737813v50.482022c-32.584486 12.149191-54.015469 14.718561-67.275495 12.149191-14.291838-2.829016-21.999947-10.189425-30.787282-22.426671-17.70788-24.646082-35.083865-69.989364-92.546986-84.820814-19.547983-5.222278-26.161062 23.912299-7.475557 28.996852 45.081378 11.67957 53.972571 43.329329 75.638365 73.579256 10.889342 15.068519 26.497473 29.084905 49.578904 33.636619 19.227376 3.736649 42.498461 0.878282 72.863535-9.372104v90.600767c-172.156811-51.825409-298.995176-207.834475-298.995175-397.100851 0.009031-231.360691 187.24565-418.59731 418.604083-418.59731z" fill="#707070" p-id="9197"></path>
            </svg>  
        </a>
    

    
        <a href='#'>
            <svg t="1612751098681" class="social-icon" viewBox="0 0 1026 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="16516" width="22" height="22">
                <path d="M512.034307 0C229.72222 0 0.002375 229.655981 0.002375 512S229.72222 1024 512.034307 1024 1024.066239 794.344019 1024.066239 512 794.346394 0 512.034307 0z m0 989.89647C248.530253 989.89647 34.169769 775.504054 34.169769 512S248.530253 34.10353 512.034307 34.10353 989.898845 248.495946 989.898845 512 775.538361 989.89647 512.034307 989.89647z" fill="#828282" p-id="16517"></path><path d="M792.845583 353.808158a119.106898 119.106898 0 0 0 8.717476-20.532369 17.083697 17.083697 0 0 0-24.939005-19.893726 192.646626 192.646626 0 0 1-52.560309 21.490333 122.332044 122.332044 0 0 0-81.810154-31.517026 121.980791 121.980791 0 0 0-121.789198 126.866409 281.673444 281.673444 0 0 1-183.130847-101.480355 17.115629 17.115629 0 0 0-27.972558 2.235251 121.757266 121.757266 0 0 0-2.107522 118.819508 20.053387 20.053387 0 0 0-6.833478 2.490707 18.233254 18.233254 0 0 0-8.430087 15.359362c0 36.242984 16.125733 69.516278 42.118499 92.124236l-1.117625 1.117625a17.051765 17.051765 0 0 0-3.448672 16.54085 121.853062 121.853062 0 0 0 69.739803 75.519521 195.871772 195.871772 0 0 1-108.760883 18.488712 17.403019 17.403019 0 0 0-18.073594 11.240115 17.115629 17.115629 0 0 0 6.865411 20.117251 314.244231 314.244231 0 0 0 169.847075 49.782212c197.340651 0 315.297992-160.299364 315.297992-315.266059l-0.031932-5.236872a227.420731 227.420731 0 0 0 49.207434-53.007359 17.083697 17.083697 0 0 0-20.787826-25.258326z m-55.721591 56.040913a17.083697 17.083697 0 0 0-7.088936 14.720718c0.191593 4.215043 0.287389 8.49395 0.287389 12.708994 0 138.20232-105.152551 281.16253-281.130598 281.162529a279.725583 279.725583 0 0 1-92.1881-15.582886 225.856056 225.856056 0 0 0 97.233379-44.385681 17.083697 17.083697 0 0 0-10.218286-30.495197 87.877261 87.877261 0 0 1-70.059124-37.105152c8.078832-0.542846 15.998004-1.883997 23.693651-3.959586a17.051765 17.051765 0 0 0-1.149558-33.20943 87.526007 87.526007 0 0 1-66.450792-60.830734c8.49395 2.139454 17.211426 3.384807 25.928901 3.672196 7.504054-0.031932 14.465261-4.630161 16.796308-11.846825s-0.415118-15.167768-6.769614-19.382812a87.685668 87.685668 0 0 1-36.498441-94.040164 315.585381 315.585381 0 0 0 209.730323 94.902332c5.620057 0.031932 10.537608-1.979793 13.954347-6.099039s4.725957-9.579643 3.512536-14.816515a87.813397 87.813397 0 0 1 149.506299-80.021954 17.083697 17.083697 0 0 0 15.774479 5.077211c5.268804-1.053761 10.473743-2.267182 15.614819-3.672196a81.043782 81.043782 0 0 1-7.216665 4.821753 17.083697 17.083697 0 0 0 10.793065 31.548959l5.81165-0.734439a178.979668 178.979668 0 0 1-9.867032 7.567918z" fill="#828282" p-id="16518"></path>
            </svg>
        </a>
    

    
        <a href='#' >
            <svg t="1612751005803" class="social-icon" viewBox="0 0 1026 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="13371" width="22" height="22">
                <path d="M512.034307 0C229.72222 0 0.002375 229.655981 0.002375 512S229.72222 1024 512.034307 1024 1024.066239 794.344019 1024.066239 512 794.346394 0 512.034307 0z m0 989.89647C248.530253 989.89647 34.169769 775.504054 34.169769 512S248.530253 34.10353 512.034307 34.10353 989.898845 248.495946 989.898845 512 775.538361 989.89647 512.034307 989.89647z" fill="#828282" p-id="13372"></path><path d="M623.796812 224.610702h-85.194961C430.096425 223.525009 416.237875 290.678309 416.237875 363.355869V416.203567h-47.898217a14.209804 14.209804 0 0 0-15.966072 15.966073v95.796432a14.209804 14.209804 0 0 0 15.966072 15.966072H416.237875v239.491082a14.337533 14.337533 0 0 0 16.061868 15.966072h97.552701c9.419983 1.085693 17.051765-6.54609 14.050143-15.966072L543.966451 543.932144h79.830361a14.209804 14.209804 0 0 0 15.966072-15.966072v-95.796432a14.209804 14.209804 0 0 0-15.966072-15.966073h-79.926157L543.966451 368.305351c3.097418-20.40464 3.097418-17.083697 22.03318-15.966072h57.126606c4.438568-0.989896 9.164525-0.44705 12.485468-3.672197 3.320943-3.225147 5.236872-7.631782 4.119247-12.293875v-95.796433A14.177872 14.177872 0 0 0 623.796812 224.610702z m-17.083697 94.008233l-40.042909-1.532743c-49.59062 0-53.741799 26.918798-53.741799 54.476238l-0.127728 60.543345a17.051765 17.051765 0 0 0 17.051765 17.083697H607.83074v61.692903h-77.914432a17.083697 17.083697 0 0 0-17.083697 17.051765L512.800679 767.457154H448.170019v-239.491082c0-9.419983-6.418361-17.051765-15.870276-17.051765H384.30573v-61.692902h47.994013a17.051765 17.051765 0 0 0 12.070351-4.981415c3.193214-3.225147 3.767993-7.567918 3.767993-12.102283v-68.81377c0-71.591867 14.465261-105.695397 90.431832-105.695398h68.111263v60.990396z" fill="#828282" p-id="13373"></path>
            </svg>
        </a>
    

    

</div>
        
        
        <div>
            <script src="https://utteranc.es/client.js"
repo='vran-dev/vran-dev.github.io'
issue-term="pathname"
label="Comment"
theme="github-light"
crossorigin="anonymous"
async>

</script>
        </div>
        

    </section>

    <footer id="footer">
    <p>
        
        © 2021 <i></i> vran
        
        ∘ Powered by <a href="http://www.gohugo.io/">Hugo</a>  ∘  Theme <a href="https://github.com/vran-dev/hugo-zenHo">ZenHo</a>
    </p>
</footer>


<script>
    var token = 'bacd84bd97ed2e6eef56ec4cae65acdb';
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?" + token;
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
    })();
</script>


</body>
