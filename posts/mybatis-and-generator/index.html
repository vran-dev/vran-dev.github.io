<!DOCTYPE html>
<html lang="en-us">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

		
		<meta name="google-site-verification" content="WQzn_X1rrhY2HHCuTYlY750m0YcuY3H73Z3T-OFsDOM" />
        

		<meta name="author" content="vran">
		
		<meta name="generator" content="Hugo 0.88.1" />
		<title>纵向丝滑，Mybatis Generator 代码持续生成实践 &middot; 且徐行</title>
		<link rel="shortcut icon" href="https://blog.cc1234.cc/images/favicon.ico">
        <link rel="stylesheet" href="https://blog.cc1234.cc/css/style.css">
        <link rel="stylesheet" href="https://blog.cc1234.cc/css/highlight.css">
</head>


<body>
    <section id="single" class="wrapper">
    <nav class="nav-main" style="display: flex;">
         <div style="margin-left:auto;">
            
            <a href='https://blog.cc1234.cc/'> Home</a>
            <a href='https://blog.cc1234.cc/posts'>Archive</a> 
            <a href='https://blog.cc1234.cc/tags'>Tags</a> 
            <a href='https://blog.cc1234.cc/about'>About</a>
   
           
         </div>
</nav>

        <article class = "post">
            <header>
                <div class = "post-img">
                    <img src='img/mybatis-icon.jpg' alt="" />
                </div>
                <div class = "title" >
                    纵向丝滑，Mybatis Generator 代码持续生成实践
                </div>
                <div class="meta">
                2021/09/09
                · vran
                </div>
            </header>
            <div class = "line"></div>
            
            <section class="content">
                <h2 id="前言">前言</h2>
<p>关于如何集成 Mybatis Generator 从而生成代码的文章不少，但是使用 Mybatis Generator 在项目中<strong>持续生成代码</strong>的实践分享就鲜有。</p>
<p>这里的持续生成代码指的是每当数据库表结构有变更时，开发者都可以使用工具重新生成对应的 Model 和 Mapper 类，而不仅仅只是第一次用它生成，后面都是手动修改了。</p>
<p>想要做到这一点（持续生成代码）的话就得解决<strong>代码重复生成时可能引入冲突</strong>，<strong>生成的代码功能不满足需求</strong>等问题，反过来说就是工程至少需要有以下特性才能够实现持续性的代码生成</p>
<ol>
<li>隔离：自动生成的代码能够以某种形式与手写的代码隔离</li>
<li>扩展性：用户不需要去修改生成的代码
<ul>
<li>可以修改代码生成的规则，比如通过修改配置或扩展代码生成工具等</li>
<li>能够以某种非侵入性的方式去扩展生成的代码的功能</li>
</ul>
</li>
<li>一致性：生成的代码结构只和项目有关，而不会受系统环境、构建工具等外部依赖的影响</li>
</ol>
<p>接下来就进入主题，分享一下我在集成 Mybatis、 Mybatis Generator 、Gradle 等工具实现持续生成代码时的一些实践和验证</p>
<blockquote>
<p>完整项目请通过 <a href="https://github.com/vran-dev/mybatis-continuous-generate-integration-demo">Github</a> 查看</p>
</blockquote>
<p><img src="img/code.png" alt="code"></p>
<h2 id="mybatis-generator-与-gradle-的集成">Mybatis Generator 与 Gradle 的集成</h2>
<p>由于 Mybatis Generator 官方没有提供 Gradle Plugin，所以我选择了通过社区开源的 Gradle 插件 <a href="https://github.com/kimichen13/mybatis-generator-plugin">Mybatis Generator Plugin</a> 来集成。</p>
<p>集成方式很简单，首先需要在 <code>build.gradle</code> 中引入一下插件，并配置指定的版本</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy"><span style="color:#000">plugins</span> <span style="color:#000">{</span>
  <span style="color:#000">id</span> <span style="color:#c41a16">&#34;com.thinkimi.gradle.MybatisGenerator&#34;</span> <span style="color:#000">version</span> <span style="color:#c41a16">&#34;2.3&#34;</span>
<span style="color:#000">}</span>
</code></pre></div><p>刷新完 Gradle 以后，我们就可以在 build.gradle 中通过 mybatisGenerator 块来配置运行时依赖的 JDBC 驱动、mybatis-generator-core 以及代码生产的规则文件</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy"><span style="color:#000">mybatisGenerator</span> <span style="color:#000">{</span>
    <span style="color:#000">verbose</span> <span style="color:#000">=</span> <span style="color:#a90d91">true</span>
    <span style="color:#000">configFile</span> <span style="color:#000">=</span> <span style="color:#c41a16">&#39;src/main/resources/mybatis-generator.xml&#39;</span>

    <span style="color:#000">dependencies</span> <span style="color:#000">{</span>
        <span style="color:#000">mybatisGenerator</span> <span style="color:#000">group:</span> <span style="color:#c41a16">&#39;org.mybatis.generator&#39;</span><span style="color:#000">,</span> <span style="color:#000">name:</span> <span style="color:#c41a16">&#39;mybatis-generator-core&#39;</span><span style="color:#000">,</span> <span style="color:#000">version:</span> <span style="color:#c41a16">&#39;1.4.0&#39;</span>
        <span style="color:#000">mybatisGenerator</span> <span style="color:#000">group:</span> <span style="color:#c41a16">&#39;mysql&#39;</span><span style="color:#000">,</span> <span style="color:#000">name:</span> <span style="color:#c41a16">&#39;mysql-connector-java&#39;</span><span style="color:#000">,</span> <span style="color:#000">version:</span> <span style="color:#c41a16">&#39;8.0.25&#39;</span>
    <span style="color:#000">}</span>
<span style="color:#000">}</span>
</code></pre></div><p>mybatis-generator.xml 就是  Mybatis Generator 依赖的规则配置，在该文件中可以配置</p>
<ul>
<li>生成的代码类型，比如 Mybatis3，Mybatis3Simple 和 Mybatis3DynamicSql 等</li>
<li>数据库的 URL、用户名、密码等</li>
<li>数据库字段与对象字段的映射规则</li>
<li>生成的代码文件存放路径</li>
<li>&hellip;&hellip;</li>
</ul>
<p>更多详细的配置请参考<a href="http://mybatis.org/generator/">官方文档</a> ，下面展示了一个简单的 Demo 配置，完整 配置示例可以通过 <a href="https://github.com/vran-dev/mybatis-continuous-generate-integration-demo">GitHub</a> 查看</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000">&lt;!</span><span style="color:#000">DOCTYPE</span> <span style="color:#000">generatorConfiguration</span> <span style="color:#000">PUBLIC</span>
        <span style="color:#c41a16">&#34;-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN&#34;</span>
        <span style="color:#c41a16">&#34;http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd&#34;</span><span style="color:#000">&gt;</span>
<span style="color:#000">&lt;</span><span style="color:#000">generatorConfiguration</span><span style="color:#000">&gt;</span>
    <span style="color:#000">&lt;</span><span style="color:#000">context</span> <span style="color:#000">id</span><span style="color:#000">=</span><span style="color:#c41a16">&#34;simple&#34;</span> <span style="color:#000">targetRuntime</span><span style="color:#000">=</span><span style="color:#c41a16">&#34;MyBatis3&#34;</span><span style="color:#000">&gt;</span>
    	<span style="color:#000">&lt;!--</span> <span style="color:#000">数据库相关配置</span> <span style="color:#000">--&gt;</span>
        <span style="color:#000">&lt;</span><span style="color:#000">jdbcConnection</span> <span style="color:#000">driverClass</span><span style="color:#000">=</span><span style="color:#c41a16">&#34;com.mysql.cj.jdbc.Driver&#34;</span>
                        <span style="color:#000">connectionURL</span><span style="color:#000">=</span><span style="color:#c41a16">&#34;jdbc:mysql://localhost:3306/user&#34;</span> <span style="color:#000">userId</span><span style="color:#000">=</span><span style="color:#c41a16">&#34;root&#34;</span> <span style="color:#000">password</span><span style="color:#000">=</span><span style="color:#c41a16">&#34;123456&#34;</span><span style="color:#000">/&gt;</span>

        <span style="color:#000">&lt;!--</span> <span style="color:#000">生成代码存放路径和包名</span> <span style="color:#000">--&gt;</span>
        <span style="color:#000">&lt;</span><span style="color:#000">javaModelGenerator</span> <span style="color:#000">targetPackage</span><span style="color:#000">=</span><span style="color:#c41a16">&#34;cc.cc1234.generate.model&#34;</span> <span style="color:#000">targetProject</span><span style="color:#000">=</span><span style="color:#c41a16">&#34;src/main/java&#34;</span><span style="color:#000">/&gt;</span>
        <span style="color:#000">&lt;</span><span style="color:#000">javaClientGenerator</span> <span style="color:#000">type</span><span style="color:#000">=</span><span style="color:#c41a16">&#34;ANNOTATEDMAPPER&#34;</span> <span style="color:#000">targetPackage</span><span style="color:#000">=</span><span style="color:#c41a16">&#34;cc.cc1234.generate.mapper&#34;</span> <span style="color:#000">targetProject</span><span style="color:#000">=</span><span style="color:#c41a16">&#34;src/main/java&#34;</span><span style="color:#000">/&gt;</span>

        <span style="color:#000">&lt;!--</span> <span style="color:#000">表与实体的映射关系配置</span> <span style="color:#000">--&gt;</span>
        <span style="color:#000">&lt;</span><span style="color:#000">table</span> <span style="color:#000">tableName</span><span style="color:#000">=</span><span style="color:#c41a16">&#34;user&#34;</span> <span style="color:#000">domainObjectName</span><span style="color:#000">=</span><span style="color:#c41a16">&#34;UserEntity&#34;</span><span style="color:#000">&gt;</span>
    		<span style="color:#000">&lt;!--</span> <span style="color:#000">字段类型映射</span> <span style="color:#000">--&gt;</span>
            <span style="color:#000">&lt;</span><span style="color:#000">columnOverride</span> <span style="color:#000">column</span><span style="color:#000">=</span><span style="color:#c41a16">&#34;gender&#34;</span> <span style="color:#000">javaType</span><span style="color:#000">=</span><span style="color:#c41a16">&#34;cc.cc1234.enums.Gender&#34;</span>
                            <span style="color:#000">typeHandler</span><span style="color:#000">=</span><span style="color:#c41a16">&#34;org.apache.ibatis.type.EnumTypeHandler&#34;</span><span style="color:#000">/&gt;</span>
        <span style="color:#000">&lt;/</span><span style="color:#000">table</span><span style="color:#000">&gt;</span>
    <span style="color:#000">&lt;/</span><span style="color:#000">context</span><span style="color:#000">&gt;</span>
<span style="color:#000">&lt;/</span><span style="color:#000">generatorConfiguration</span><span style="color:#000">&gt;</span>
</code></pre></div><p>这样配置完成后，Mybatis Generator Plugin 会自动创建一个名为 <strong>mbGenerator</strong> 的 Gradle Task，执行该 Task 就能生成对应的 Entity 和 Mapper 代码文件，这部分通过工具自动生成的代码文件在后面都会称之为 Generated Code。</p>
<p><img src="img/gradle-task.png" alt="gradle-task"></p>
<h2 id="generated-code-的隔离">Generated Code 的隔离</h2>
<p>目前所有的 Generated Code 都是存放在一个 targetProject （src/main/java）下，通过包路径 <strong>cc.cc1234.generate</strong> 来区分这些文件是不是由工具自动生成的。</p>
<p>通过包路径的方式来隔离 Generated Code 这种方式我觉得可以再优化一下，我期望是达到一种形散神不散的阻止方式，答案就是<strong>源码目录</strong>来做隔离。</p>
<p>那么什么是源码目录呢？一般默认的 Java 目录结构如下</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">project
└── src
    ├── main
    │   ├── java
    │   └── resources
    └── test
        ├── java
        └── resources
</code></pre><p>这里的 main 就是源码目录，而我要做的就是创建一个和 main 同级的目录专门用来存放 Generated Code，该目录的名称为 <strong>generator</strong>。</p>
<p>也就是新的项目结构就变成了下面这样</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">project
└── src
    ├── generator
    │   ├── java
    │   └── resources
    ├── main
    │   ├── java
    │   └── resources
    └── test
        ├── java
        └── resources
</code></pre><p>generator 目录需要做到以下两点</p>
<ol>
<li><strong>generator</strong> 能够引用到 project 项目下的依赖</li>
<li>main 下的代码能引用到 <strong>generator</strong> 下的代码</li>
</ol>
<p>Gradle 中这个可以很轻松的实现， 只需要在 build.gradle 中配置 SourceSet 既可以</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy"><span style="color:#000">sourceSets</span> <span style="color:#000">{</span>
    <span style="color:#177500">// 将 generator 目录加入 main 所属的源码目录集合中去
</span><span style="color:#177500"></span>    <span style="color:#000">main</span> <span style="color:#000">{</span>
        <span style="color:#000">java</span><span style="color:#000">.</span><span style="color:#836c28">srcDirs</span> <span style="color:#000">+=</span> <span style="color:#000">[</span><span style="color:#c41a16">&#39;src/generator/java&#39;</span><span style="color:#000">]</span>
        <span style="color:#000">resources</span><span style="color:#000">.</span><span style="color:#836c28">srcDirs</span> <span style="color:#000">+=</span> <span style="color:#000">[</span><span style="color:#c41a16">&#39;src/generator/resources&#39;</span><span style="color:#000">]</span>
    <span style="color:#000">}</span>
<span style="color:#000">}</span>
</code></pre></div><p>最后，再将 Mybatis Generator 的代码生成目标目录（targetProject）修改为 <strong>src/generator/java</strong> 即可</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#633820">&lt;!DOCTYPE generatorConfiguration PUBLIC
</span><span style="color:#633820">        &#34;-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN&#34;
</span><span style="color:#633820">        &#34;&lt;http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd&gt;</span>&#34;&gt;
<span style="color:#000">&lt;generatorConfiguration&gt;</span>

    <span style="color:#000">&lt;context</span> <span style="color:#836c28">id=</span><span style="color:#c41a16">&#34;dsql&#34;</span> <span style="color:#836c28">targetRuntime=</span><span style="color:#c41a16">&#34;MyBatis3&#34;</span><span style="color:#000">&gt;</span>
        <span style="color:#177500">&lt;!-- ...... --&gt;</span>
        <span style="color:#000">&lt;javaModelGenerator</span> <span style="color:#836c28">targetPackage=</span><span style="color:#c41a16">&#34;cc.cc1234.dao.generator.model&#34;</span> <span style="color:#836c28">targetProject=</span><span style="color:#c41a16">&#34;src/generator/java&#34;</span><span style="color:#000">/&gt;</span>
        <span style="color:#000">&lt;javaClientGenerator</span> <span style="color:#836c28">targetPackage=</span><span style="color:#c41a16">&#34;cc.cc1234.dao.generator.mapper&#34;</span> <span style="color:#836c28">targetProject=</span><span style="color:#c41a16">&#34;src/generator/java&#34;</span> <span style="color:#000">/&gt;</span>
        <span style="color:#177500">&lt;!-- ...... --&gt;</span>
    <span style="color:#000">&lt;/context&gt;</span>

<span style="color:#000">&lt;/generatorConfiguration&gt;</span>
</code></pre></div><p>这样就完全将 Generated Code 通过源码目录隔离开了。</p>
<p>下面是我加的一个代码生成的前置处理逻辑：先删除目录下已生成的旧代码。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy"><span style="color:#000">mbGenerator</span><span style="color:#000">.</span><span style="color:#836c28">dependsOn</span> <span style="color:#000">{</span>
    <span style="color:#000">cleanGeneratedCode</span>
<span style="color:#000">}</span>

<span style="color:#000">task</span> <span style="color:#000">cleanGeneratedCode</span><span style="color:#000">(</span><span style="color:#000">type:</span> <span style="color:#000">Delete</span><span style="color:#000">)</span> <span style="color:#000">{</span>
    <span style="color:#000">file</span><span style="color:#000">(</span><span style="color:#c41a16">&#34;src/generator/java&#34;</span><span style="color:#000">).</span><span style="color:#836c28">list</span><span style="color:#000">().</span><span style="color:#836c28">each</span> <span style="color:#000">{</span>
        <span style="color:#000">f</span> <span style="color:#000">-&gt;</span> <span style="color:#000">delete</span> <span style="color:#c41a16">&#34;src/generator/java/${f}&#34;</span>
    <span style="color:#000">}</span>
    <span style="color:#000">file</span><span style="color:#000">(</span><span style="color:#c41a16">&#34;src/generator/resources&#34;</span><span style="color:#000">).</span><span style="color:#836c28">list</span><span style="color:#000">().</span><span style="color:#836c28">each</span> <span style="color:#000">{</span>
        <span style="color:#000">f</span> <span style="color:#000">-&gt;</span> <span style="color:#000">delete</span> <span style="color:#c41a16">&#34;src/generator/resources/${f}&#34;</span>
    <span style="color:#000">}</span>
<span style="color:#000">}</span>
</code></pre></div><h2 id="generated-code-的扩展">Generated Code 的扩展</h2>
<p>生成的代码必然是无法满足复杂多变的业务场景的，这就需要有能在不修改 Generated Code 的前提下扩展功能的能力，在这里分为两种</p>
<ol>
<li>扩展代码生成规则</li>
<li>无侵入式的扩展 Generated Code</li>
</ol>
<p>在本文中就是扩展 Mybatis Generator 的代码生成能力和扩展已生成的 Mapper 功能。</p>
<h3 id="mybatis-generator-的扩展">Mybatis Generator 的扩展</h3>
<p>Mybatis Generator 提供很丰富的扩展点，我这里就不赘述了，读者可以通过<a href="http://mybatis.org/generator/reference/extending.html">官方文档</a>详细了解。</p>
<p>在我的 Demo 项目中，我基于它的扩展机制实现了以下几个插件，实现逻辑请通过 Github 查看</p>
<ol>
<li>Model 类使用 <code>@Data</code> 注解替代 getter 和 setter</li>
<li>全局禁用 <code>Example</code> 方法和实体的生成</li>
<li>默认为 <code>Insert</code>、<code>InsertSelective</code> 方法生成 GenerateKeys 配置</li>
<li>修改 <code>selectByPrimaryKey</code> 方法返回类型为 <code>Optional</code></li>
</ol>
<p>验证完 Mybatis Generator 的扩展能力以后，下面就该验证一下 Mapper 类的扩展了。</p>
<h3 id="mapper-的扩展">Mapper 的扩展</h3>
<p>自动生成的 Mapper 类提供了简单的 CRUD 函数</p>
<ul>
<li>deleteByPrimaryKey</li>
<li>insert</li>
<li>insertSelective</li>
<li>selectByPrimaryKey</li>
<li>updateByPrimaryKeySelective</li>
<li>updateByPrimaryKey</li>
</ul>
<p>我刻意禁用了 XML 文件的生成，这些函数都是使用 Mybatis 自带的 Annotation 和 SqlProvider 实现的。</p>
<p>如果提供的函数无法满足需求，这时候就可以通过继承该 Mapper 来进行扩展，就像这样</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a90d91">interface</span> <span style="color:#3f6e75">UserMapper</span> <span style="color:#a90d91">extends</span> <span style="color:#000">UserGeneratedMapper</span><span style="color:#000">{</span>
    
<span style="color:#000">}</span>
</code></pre></div><p>自定义 CRUD 既可以使用 Annotation，也可以使用传统的 XML</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a90d91">interface</span> <span style="color:#3f6e75">UserMapper</span> <span style="color:#a90d91">extends</span> <span style="color:#000">UserGeneratedMapper</span><span style="color:#000">{</span>
    
    <span style="color:#177500">/**
</span><span style="color:#177500">    * 使用 Annotation 写 SQL
</span><span style="color:#177500">    */</span>
    <span style="color:#000">@Select</span><span style="color:#000">(</span><span style="color:#000">value</span> <span style="color:#000">=</span> <span style="color:#c41a16">&#34;select * from user where deleted = false&#34;</span><span style="color:#000">)</span>
    <span style="color:#000">List</span><span style="color:#000">&lt;</span><span style="color:#000">UserEntity</span><span style="color:#000">&gt;</span> <span style="color:#000">selectAll</span><span style="color:#000">();</span>
    
    <span style="color:#177500">/**
</span><span style="color:#177500">    * 使用 XML 写 SQL
</span><span style="color:#177500">    */</span>
    <span style="color:#000">UserEntity</span> <span style="color:#000">selectByUsername</span><span style="color:#000">(</span><span style="color:#000">String</span> <span style="color:#000">username</span><span style="color:#000">);</span>

    <span style="color:#177500">/**
</span><span style="color:#177500">    * 使用 XML 写 SQL
</span><span style="color:#177500">    */</span>
    <span style="color:#a90d91">long</span> <span style="color:#000">countUser</span><span style="color:#000">();</span>
    
<span style="color:#000">}</span>
</code></pre></div><p>对应的 XML</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#633820">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span style="color:#633820">&lt;!DOCTYPE mapper PUBLIC &#34;-//mybatis.org//DTD Mapper 3.0//EN&#34; &#34;http://mybatis.org/dtd/mybatis-3-mapper.dtd&#34;&gt;</span>
<span style="color:#000">&lt;mapper</span> <span style="color:#836c28">namespace=</span><span style="color:#c41a16">&#34;cc.cc1234.dao.mapper.UserMapper&#34;</span><span style="color:#000">&gt;</span>

    <span style="color:#000">&lt;select</span> <span style="color:#836c28">id=</span><span style="color:#c41a16">&#34;countUser&#34;</span> <span style="color:#836c28">resultType=</span><span style="color:#c41a16">&#34;java.lang.Long&#34;</span><span style="color:#000">&gt;</span>
        select count(*)
        from user
    <span style="color:#000">&lt;/select&gt;</span>

    <span style="color:#000">&lt;select</span> <span style="color:#836c28">id=</span><span style="color:#c41a16">&#34;selectByUsername&#34;</span> <span style="color:#836c28">resultType=</span><span style="color:#c41a16">&#34;cc.cc1234.dao.model.UserEntity&#34;</span><span style="color:#000">&gt;</span>
        select *
        from user
        where username = #{username}
    <span style="color:#000">&lt;/select&gt;</span>

<span style="color:#000">&lt;/mapper&gt;</span>

</code></pre></div><p>在 Mybatis 中 Model 对象仅仅用作承载数据，很少需要去扩展它的能力，所以这里就不考虑它的扩展方式了。</p>
<h2 id="generated-code-的一致性">Generated Code 的一致性</h2>
<p>完成了代码生成、隔离、扩展性的验证以后，接下来又得考虑一个团队开发时的问题：如何确保每个团队成员生成的代码是一致的？</p>
<p>由于 Generated Code 是基于 Database 的 Schema 来生成的，所以只要团队成员能共享一份 Schema 其实就能保证生成的代码是一致的了。</p>
<p>而这里就有两个方案</p>
<ul>
<li>
<p>在生成代码时，成员使用一个共享的 Database，所有的数据库结构变更都应该先应用到该 Database</p>
</li>
<li>
<p>在项目中维护 Database 的 Schema 变更操作记录，成员可以通过重放历史变更操作得到最新一份最新的 Schema</p>
</li>
</ul>
<p>这两种方案并不是互斥的，如果条件允许的话，完全可以结合起来应用。</p>
<p>对于维护 Database 的 Schema 变更记录，目前社区已经有了很多成熟的产品可以开箱即用，我这里选择了 <a href="https://flywaydb.org/">Flyway</a> 。</p>
<p>Flyway 将 Schema 的变更操作称之为 Migration，每个 Migration 是一个有版本标识的 SQL 文件，像下面这样</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">migration
├── v1__init.sql
├── v2_1__user_table.sql
├── v2_2__order_table.sql
└── v3__order_item_table.sql
</code></pre><p>Flyway 会自动应用这些 SQL 文件，并记录当前使用到的版本。</p>
<p>这样，成员就算在本地开发也可以得到一个与当前生产环境一致的 Database Schema 了。</p>
<p><img src="img/integration-flyway.png" alt="integration-flyway"></p>
<p>如果你的生产不允许通过 Flyway 来应用  SQL 的话，那么你可以选择在生产环境禁用Flyway，但是在本地和开发环境继续启用。</p>
<p>关于 Flyway 的集成细节的话这里就不展示了，可以直接通过 <a href="https://github.com/vran-dev/mybatis-continuous-generate-integration-demo">Github</a> 查看项目配置</p>
<h2 id="总结">总结</h2>
<p>到目前为止， 基本实现了使用  Mybatis Generator 来做代码的持续生成。</p>
<p>不过目前的优化点其实还蛮多的</p>
<ul>
<li>在生成的 Mapper 中已经为实体定义了 ResultMap，但是没有生成 ID，后续可以考虑生成一个 ID，这样扩展的 XML  里就不需要再重复写 ResultMap，直接引用 ID 即可</li>
<li>提供一个更通用的 CRUD 基础 Mapper 的实现</li>
</ul>
<p>还有，XML 目前不能自动生成的，因为文件的映射是和类作了强绑定，限制了扩展能力。</p>
<p>如果要支持生成 XML 的话，目前有两个想法（没有深入思考，有空了再尝试一下吧）</p>
<ul>
<li>XML 中 mapper.namespce 指向一个通用路由 Mapper</li>
<li>一个 Mapper 可以对应多个 XML 文件，在 Mybatis 启动时做合并</li>
</ul>
<p>对了，Mybatis Generator 也支持生成 Mybatis Dynamic SQL 的代码，可以参考我上一篇文章<a href="https://mp.weixin.qq.com/s/Sr5Wj-BCIehletz6kUeYoQ">《纵享丝滑，Mybatis-Dynamic-Sql 集成体验》</a>。</p>
<h2 id="附录">附录</h2>
<ol>
<li><a href="https://github.com/vran-dev/mybatis-continuous-generate-integration-demo">Mybatis continuous generate integration demo</a></li>
<li><a href="https://mybatis.org/generator/index.html">Mybatis Generator docs</a></li>
<li><a href="https://mybatis.org/mybatis-3/">Mybatis docs</a></li>
<li><a href="https://github.com/kimichen13/mybatis-generator-plugin">Mybatis Generator Plugin</a></li>
<li><a href="https://flywaydb.org/">Flyway</a></li>
</ol>

            </section>

            <div class="over">
                <div class="line"></div>
                <span>over</span>
                <div class="line"></div>
            </div>
        </article>
        <div class = "social">

    
        <a href="https://github.com/vran-dev">
            <svg t="1612751476854" class="social-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="9196" width="22" height="22">
                <path d="M63.681087 516.285293c0 210.288698 144.593659 387.06044 340.109608 435.411104 8.963443 2.334559 18.979018-5.66029 18.685506-14.948855V740.533933c0-9.954615 5.899616-19.5096 16.818309-25.228593 11.097059-5.5474 8.380932-25.607902-3.738907-28.030515-56.790299-11.356705-105.233532-34.160427-139.233656-64.471315-33.930132-30.367333-53.245562-67.216792-53.245561-106.518217 0-27.359951 9.783022-53.611324 27.084499-77.566521a14.623733 14.623733 0 0 0 2.817728-8.365127v-142.999656l118.721594 63.536587c3.619244 1.971054 8.143864 2.291661 12.088231 0.889571 33.284403-9.868819 69.433946-14.890153 108.385412-14.890153 38.949208 0 75.096494 5.021334 108.385413 14.948856a15.36429 15.36429 0 0 0 12.146933-0.891829l118.662892-63.59529v142.91386a15.115932 15.115932 0 0 0 2.801922 8.42383c17.346633 23.925846 27.098046 50.235922 27.098047 77.564263 0 39.333033-19.268016 76.180235-53.200406 106.547568-34.043022 30.310888-82.5427 53.083-139.278811 64.471315-12.115324 2.363911-14.77049 22.42667-3.73665 27.971813 10.923209 5.723508 16.822825 15.240111 16.822825 25.23085v196.215867c-0.295771 9.28405 9.749156 17.281157 18.685505 14.948855C816.104564 903.343476 960.668872 726.517546 960.668872 516.285293c0-247.50392-201.00239-448.495021-448.492764-448.495021-247.50392 0-448.495021 200.991101-448.495021 448.495021z m448.495021-418.595052c231.37198 0 418.590537 187.236619 418.590537 418.595052 0 189.266376-126.779662 345.246091-298.995176 397.046664v-172.800282c0-11.970825-4.610416-22.60052-11.209949-31.769422 49.723403-13.666429 95.127645-35.156114 127.946942-64.471315 38.922115-34.600697 62.660564-78.952807 62.660564-128.005645 0-32.381285-11.794717-62.003545-29.897711-88.808078v-165.336015c0.085796-10.469392-13.314213-18.322-22.428928-13.068113l-137.34614 73.755365c-34.108498-9.254699-70.578648-15.840684-109.320139-15.840685-38.718913 0-75.277118 6.525025-109.322397 15.840685l-137.352913-73.726013c-9.094395-5.253887-22.510209 2.598721-22.424412 13.068113v165.336014c-18.116541 26.806791-29.899969 56.429051-29.899969 88.808079 0 49.025744 23.7678 93.375596 62.617665 127.978551 32.878 29.373903 78.32514 50.804886 127.962747 64.532275-6.572439 9.137293-11.185113 19.737637-11.185113 31.737813v50.482022c-32.584486 12.149191-54.015469 14.718561-67.275495 12.149191-14.291838-2.829016-21.999947-10.189425-30.787282-22.426671-17.70788-24.646082-35.083865-69.989364-92.546986-84.820814-19.547983-5.222278-26.161062 23.912299-7.475557 28.996852 45.081378 11.67957 53.972571 43.329329 75.638365 73.579256 10.889342 15.068519 26.497473 29.084905 49.578904 33.636619 19.227376 3.736649 42.498461 0.878282 72.863535-9.372104v90.600767c-172.156811-51.825409-298.995176-207.834475-298.995175-397.100851 0.009031-231.360691 187.24565-418.59731 418.604083-418.59731z" fill="#707070" p-id="9197"></path>
            </svg>  
        </a>
    

    
        <a href='#'>
            <svg t="1612751098681" class="social-icon" viewBox="0 0 1026 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="16516" width="22" height="22">
                <path d="M512.034307 0C229.72222 0 0.002375 229.655981 0.002375 512S229.72222 1024 512.034307 1024 1024.066239 794.344019 1024.066239 512 794.346394 0 512.034307 0z m0 989.89647C248.530253 989.89647 34.169769 775.504054 34.169769 512S248.530253 34.10353 512.034307 34.10353 989.898845 248.495946 989.898845 512 775.538361 989.89647 512.034307 989.89647z" fill="#828282" p-id="16517"></path><path d="M792.845583 353.808158a119.106898 119.106898 0 0 0 8.717476-20.532369 17.083697 17.083697 0 0 0-24.939005-19.893726 192.646626 192.646626 0 0 1-52.560309 21.490333 122.332044 122.332044 0 0 0-81.810154-31.517026 121.980791 121.980791 0 0 0-121.789198 126.866409 281.673444 281.673444 0 0 1-183.130847-101.480355 17.115629 17.115629 0 0 0-27.972558 2.235251 121.757266 121.757266 0 0 0-2.107522 118.819508 20.053387 20.053387 0 0 0-6.833478 2.490707 18.233254 18.233254 0 0 0-8.430087 15.359362c0 36.242984 16.125733 69.516278 42.118499 92.124236l-1.117625 1.117625a17.051765 17.051765 0 0 0-3.448672 16.54085 121.853062 121.853062 0 0 0 69.739803 75.519521 195.871772 195.871772 0 0 1-108.760883 18.488712 17.403019 17.403019 0 0 0-18.073594 11.240115 17.115629 17.115629 0 0 0 6.865411 20.117251 314.244231 314.244231 0 0 0 169.847075 49.782212c197.340651 0 315.297992-160.299364 315.297992-315.266059l-0.031932-5.236872a227.420731 227.420731 0 0 0 49.207434-53.007359 17.083697 17.083697 0 0 0-20.787826-25.258326z m-55.721591 56.040913a17.083697 17.083697 0 0 0-7.088936 14.720718c0.191593 4.215043 0.287389 8.49395 0.287389 12.708994 0 138.20232-105.152551 281.16253-281.130598 281.162529a279.725583 279.725583 0 0 1-92.1881-15.582886 225.856056 225.856056 0 0 0 97.233379-44.385681 17.083697 17.083697 0 0 0-10.218286-30.495197 87.877261 87.877261 0 0 1-70.059124-37.105152c8.078832-0.542846 15.998004-1.883997 23.693651-3.959586a17.051765 17.051765 0 0 0-1.149558-33.20943 87.526007 87.526007 0 0 1-66.450792-60.830734c8.49395 2.139454 17.211426 3.384807 25.928901 3.672196 7.504054-0.031932 14.465261-4.630161 16.796308-11.846825s-0.415118-15.167768-6.769614-19.382812a87.685668 87.685668 0 0 1-36.498441-94.040164 315.585381 315.585381 0 0 0 209.730323 94.902332c5.620057 0.031932 10.537608-1.979793 13.954347-6.099039s4.725957-9.579643 3.512536-14.816515a87.813397 87.813397 0 0 1 149.506299-80.021954 17.083697 17.083697 0 0 0 15.774479 5.077211c5.268804-1.053761 10.473743-2.267182 15.614819-3.672196a81.043782 81.043782 0 0 1-7.216665 4.821753 17.083697 17.083697 0 0 0 10.793065 31.548959l5.81165-0.734439a178.979668 178.979668 0 0 1-9.867032 7.567918z" fill="#828282" p-id="16518"></path>
            </svg>
        </a>
    

    
        <a href='#' >
            <svg t="1612751005803" class="social-icon" viewBox="0 0 1026 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="13371" width="22" height="22">
                <path d="M512.034307 0C229.72222 0 0.002375 229.655981 0.002375 512S229.72222 1024 512.034307 1024 1024.066239 794.344019 1024.066239 512 794.346394 0 512.034307 0z m0 989.89647C248.530253 989.89647 34.169769 775.504054 34.169769 512S248.530253 34.10353 512.034307 34.10353 989.898845 248.495946 989.898845 512 775.538361 989.89647 512.034307 989.89647z" fill="#828282" p-id="13372"></path><path d="M623.796812 224.610702h-85.194961C430.096425 223.525009 416.237875 290.678309 416.237875 363.355869V416.203567h-47.898217a14.209804 14.209804 0 0 0-15.966072 15.966073v95.796432a14.209804 14.209804 0 0 0 15.966072 15.966072H416.237875v239.491082a14.337533 14.337533 0 0 0 16.061868 15.966072h97.552701c9.419983 1.085693 17.051765-6.54609 14.050143-15.966072L543.966451 543.932144h79.830361a14.209804 14.209804 0 0 0 15.966072-15.966072v-95.796432a14.209804 14.209804 0 0 0-15.966072-15.966073h-79.926157L543.966451 368.305351c3.097418-20.40464 3.097418-17.083697 22.03318-15.966072h57.126606c4.438568-0.989896 9.164525-0.44705 12.485468-3.672197 3.320943-3.225147 5.236872-7.631782 4.119247-12.293875v-95.796433A14.177872 14.177872 0 0 0 623.796812 224.610702z m-17.083697 94.008233l-40.042909-1.532743c-49.59062 0-53.741799 26.918798-53.741799 54.476238l-0.127728 60.543345a17.051765 17.051765 0 0 0 17.051765 17.083697H607.83074v61.692903h-77.914432a17.083697 17.083697 0 0 0-17.083697 17.051765L512.800679 767.457154H448.170019v-239.491082c0-9.419983-6.418361-17.051765-15.870276-17.051765H384.30573v-61.692902h47.994013a17.051765 17.051765 0 0 0 12.070351-4.981415c3.193214-3.225147 3.767993-7.567918 3.767993-12.102283v-68.81377c0-71.591867 14.465261-105.695397 90.431832-105.695398h68.111263v60.990396z" fill="#828282" p-id="13373"></path>
            </svg>
        </a>
    

    

</div>
        
        
        <div>
            <script src="https://utteranc.es/client.js"
repo='vran-dev/vran-dev.github.io'
issue-term="pathname"
label="Comment"
theme="github-light"
crossorigin="anonymous"
async>

</script>
        </div>
        

    </section>

    <footer id="footer">
    <p>
        
        © 2021 <i></i> vran
        
        ∘ Powered by <a href="http://www.gohugo.io/">Hugo</a>  ∘  Theme <a href="https://github.com/vran-dev/hugo-zenHo">ZenHo</a>
    </p>
</footer>


<script>
    var token = 'bacd84bd97ed2e6eef56ec4cae65acdb';
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?" + token;
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
    })();
</script>


</body>
