<!DOCTYPE html>
<html lang="en-us">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		
		<meta name="author" content="vran">
		<meta name="description" content="且徐行">
		<meta name="generator" content="Hugo 0.80.0" />
		<title>  你知道 Java 的偏向锁要被废弃掉了吗？  &middot; 且徐行</title>
		<link rel="shortcut icon" href="https://blog.cc1234.cc/images/favicon.ico">
		<link rel="stylesheet" href="https://blog.cc1234.cc/css/style.css">
		<link rel="stylesheet" href="https://blog.cc1234.cc/css/highlight.css">

		
		<link rel="stylesheet" href="https://blog.cc1234.cc/css/monosocialiconsfont.css">
		

		

		
	</head>

    <body>
       <nav class="main-nav">
	
	
		<a href='https://blog.cc1234.cc/'> Home</a>
	
	<a href='https://blog.cc1234.cc/posts'>Archive</a>
	<a href='https://blog.cc1234.cc/tags'>Tags</a>
	<a href='https://blog.cc1234.cc/about'>About</a>

	

	
</nav>


        <section id="wrapper" class="post">
            <article>
                <header>
                    <h1>
                          你知道 Java 的偏向锁要被废弃掉了吗？ 
                    </h1>
                    <h2 class="headline">
                    2021/02/01 23:45
                    · By vran
                      <span class="tags">
                      
                      
                          
                              <a href="https://blog.cc1234.cc/tags/java">Java</a>&nbsp;
                          
                              <a href="https://blog.cc1234.cc/tags/jvm">JVM</a>&nbsp;
                          
                      
                      
                      </span>
                    </h2>
                </header>
                
                <section id="post-body">
                    <h2 id="前言">前言</h2>
<p><strong>偏向锁</strong>是从 JDK1.6 引入的一种针对 <strong>synchronized</strong> 的锁优化技术，然而从 JDK 15 开始，这一特性被官方标记为废弃状态，如果还想继续使用的话需要通过 JVM 参数手动启用。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">XX:<span style="color:#f92672">+</span>UseBiasedLocking
</code></pre></div><p>那么问题来了，JDK15 为什么要废弃偏向锁呢？</p>
<h2 id="什么是偏向锁">什么是偏向锁？</h2>
<p>在回答 Why 之前要先明白 What：什么是偏向锁？</p>
<p>在 Java 中可以使用 <strong>synchronized</strong> 来保证代码块同一时间只被一个线程访问（互斥），它是基于 Monitor Object 模式来实现的。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">int</span> i<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">mutex</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  i<span style="color:#f92672">++;</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">mutext2</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">synchronized</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    i<span style="color:#f92672">++;</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>当线程请求进入临界区时都需要先获取一个 monitor 对象（类似于准入许可证），获取 monitor 对象是通过 compare-and-swap (CAS) 操作来实现的。</p>
<p>从 CPU 的角度来看，CAS 其实是一个开销很昂贵的操作，有没有什么方法可以避免呢？</p>
<p>我们先看一个 JAVA 团队观察到的现象：</p>
<blockquote>
<p>在大多数对象的生命周期内，基本上只会有一个线程访问临界区</p>
</blockquote>
<p>基于此可以得出一个优化方案：当某个线程<strong>首次访问</strong>临界区时记录下该线程的信息，当再有线程访问该临界区时判断是否是首次访问的线程</p>
<ul>
<li>如果是：就直接放行，这样就避免了通过 CAS 获取 monitor 的操作</li>
<li>如果不是：就升级为轻量级锁</li>
</ul>
<p>这个优化方案其实就是<strong>偏向锁</strong>了，在 JVM 的实际实现中，锁升级其实有 4 个状态，并且是只可升级不可降级。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">无锁 <span style="color:#f92672">-&gt;</span> 偏向锁 <span style="color:#f92672">-&gt;</span> 轻量级锁 <span style="color:#f92672">-&gt;</span> 重量级锁
</code></pre></div><h2 id="为什么要废弃">为什么要废弃？</h2>
<p>那为什么时隔多年后，Java 团队又要废弃这个优化呢？</p>
<h4 id="大人时代变了">大人，时代变了</h4>
<p>在过去，Java 应用通常使用的都是 HashTable、Vector 等比较老的集合库，这类集合库大量使用了 synchronized  来保证线程安全。</p>
<p>如果在单线程的情景下使用这些集合库就会有不必要的加锁操作，从而导致性能下降。</p>
<p>而偏向锁可以保证即使是使用了这些老的集合库，也不会产生很大的性能损耗，因为 JVM 知道访问临界区的线程始终是同一个，也就避免了加锁操作。</p>
<p>这一切都很美好，但是随着时代的变化，新的 Java 应用基本都已经使用了无锁的集合库，比如  HashMap、ArrayList 等，这些集合库在单线程场景下比老的集合库性能更好。</p>
<p>即使是在多线程场景下，Java 也提供了 ConcurrentHashMap、CopyOnWriteArrayList 等性能更好的线程安全的集合库。</p>
<p>综上，<strong>对于使用了新类库的 Java 应用来说，偏向锁带来的收益已不如过去那么明显，而且在当下多线程应用越来越普遍的情况下，偏向锁带来的锁升级操作反而会影响应用的性能</strong>。</p>
<h4 id="时代变了成本却还在增加">时代变了，成本却还在增加</h4>
<p>在废弃偏向锁的提案 <a href="https://openjdk.java.net/jeps/374">JEP374</a> 中还提到了与 HotSpot 相关的一点</p>
<blockquote>
<p>Biased locking introduced a lot of complex code into the synchronization subsystem and is invasive to other HotSpot components as well.</p>
</blockquote>
<p>简单翻译就是<strong>偏向锁</strong>为整个「同步子系统」引入了大量的复杂度，并且这些复杂度也入侵到了 HotSpot 的其它组件。</p>
<p>这导致了系统代码难以理解，难以进行大的设计变更，降低了子系统的演进能力，</p>
<p>总结下来其实就是 ROI （投资回报率）太低了，考虑到兼容性，所以决定先废弃该特性，最终的目标是移除它。</p>
<h2 id="后续如何兼容">后续如何兼容？</h2>
<p>默认禁用偏向锁可能会导致一些 Java 应用的性能下降，所以 HotSpot 提供了显示开启偏向锁的命令</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 在 Java15 后，手动开启偏向锁在启动的时候会收到警告信息</span>
-XX:+UseBiasedLocking
</code></pre></div><p>以下和偏向锁相关的命令参数仍然可以使用，但是虚拟机会列出对应的警告信息标示其已被废弃掉</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">-XX:BiasedLockingStartupDelay<span style="color:#f92672">=</span>__
-XX:BiasedLockingBulkRebiasThreshold<span style="color:#f92672">=</span>__
-XX:BiasedLockingBulkRevokeThreshold<span style="color:#f92672">=</span>__
-XX:BiasedLockingDecayTime<span style="color:#f92672">=</span>__
// 必须在 C2 下才能使用
-XX:+UseOptoBiasInlining

// 必须配合参数-XX:+UnlockDiagnosticVMOptions使用
// 并且只能加在其后才能生效
-XX:+PrintBiasedLockingStatistics
-XX:+PrintPreciseBiasedLockingStatistics
</code></pre></div><p>so，扶我起来，我还能学！</p>
<h2 id="参考">参考</h2>
<ol>
<li><a href="https://openjdk.java.net/jeps/374">JEP 374: Disable and Deprecate Biased Locking</a></li>
<li><a href="http://openjdk.java.net/projects/jdk/15/">open JDK15 Release</a></li>
<li><a href="https://wiki.openjdk.java.net/display/HotSpot/Synchronization">Synchronization and Object Locking</a> By Christian Wimmer</li>
<li><a href="https://blogs.oracle.com/dave/biased-locking-in-hotspot">Biased Locking in HotSpot</a></li>
<li><a href="https://developer.ibm.com/zh/articles/j-lo-synchronized/">探索 Java 同步机制</a></li>
</ol>

                </section>
            </article>
           
            <hr/> 
            

            

            
                <ul id="post-list" class="archive readmore">
    <h3>也许还有您感兴趣的文章</h3>

    
    
    
        <li>
            <a href="/posts/how-to-develop-prettyzoo/">我是如何开发了一款‘有人用’的开源软件<aside class="dates">2020 / 11 / 22</aside></a>
        </li>
    
        <li>
            <a href="/posts/scala-adt/"> Scala 与 Algebraic data type<aside class="dates">2020 / 08 / 18</aside></a>
        </li>
    
        <li>
            <a href="/posts/typeclasses-deriving/"> Scala2 如何实现 Type class 派生<aside class="dates">2020 / 08 / 15</aside></a>
        </li>
    
        <li>
            <a href="/posts/vavr-1/"> VAVR：颠覆你的 Java 体验 <aside class="dates">2020 / 07 / 25</aside></a>
        </li>
    
        <li>
            <a href="/posts/typeclasses-2/">真的学不动了：Scala3 与 Type classes<aside class="dates">2020 / 07 / 19</aside></a>
        </li>
    
</ul>

            
 <script src="https://utteranc.es/client.js"
           repo="vran-dev/vran-dev.github.io"
          issue-term="pathname"
           label="Comment"
           theme="github-light"
           crossorigin="anonymous"
           async>
   </script>

            <footer id="footer">
    
        <div id="social">

	
	
    
    <a class="symbol" href="https://github.com/vran-dev">
        github
    </a>
    


</div>

    
    <p class="small">
    
       © Copyright 2021 <i class="fa fa-heart" aria-hidden="true"></i> vran
    
    </p>
    <p class="small">
        Powered by <a href="http://www.gohugo.io/">Hugo</a> Theme By <a href="https://github.com/nodejh/hugo-theme-cactus-plus">nodejh</a>
    </p>
</footer>

        </section>

        <script src="https://blog.cc1234.cc/js/jquery-3.3.1.min.js"></script>
<script src="https://blog.cc1234.cc/js/main.js"></script>
<script src="https://blog.cc1234.cc/js/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>







    </body>
</html>
