<!DOCTYPE html>
<html lang="en-us">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

		
		<meta name="google-site-verification" content="WQzn_X1rrhY2HHCuTYlY750m0YcuY3H73Z3T-OFsDOM" />
        

		<meta name="author" content="vran">
		
		<meta name="generator" content="Hugo 0.88.1" />
		<title>千呼万唤： Pattern Matching for JAVA &middot; 且徐行</title>
		<link rel="shortcut icon" href="https://blog.cc1234.cc/images/favicon.ico">
        <link rel="stylesheet" href="https://blog.cc1234.cc/css/style.css">
        <link rel="stylesheet" href="https://blog.cc1234.cc/css/highlight.css">
</head>


<body>
    <section id="single" class="wrapper">
    <nav class="nav-main" style="display: flex;">
         <div style="margin-left:auto;">
            
            <a href='https://blog.cc1234.cc/'> Home</a>
            <a href='https://blog.cc1234.cc/posts'>Archive</a> 
            <a href='https://blog.cc1234.cc/tags'>Tags</a> 
            <a href='https://blog.cc1234.cc/about'>About</a>
   
           
         </div>
</nav>

        <article class = "post">
            <header>
                <div class = "post-img">
                    <img src='' alt="" />
                </div>
                <div class = "title" >
                    千呼万唤： Pattern Matching for JAVA
                </div>
                <div class="meta">
                2021/10/18
                · vran
                </div>
            </header>
            <div class = "line"></div>
            
            <section class="content">
                <h2 id="一声惊雷">一声惊雷</h2>
<p>2021 年 9 月一声惊雷，Java17 正式发布了，这是自 Java11 过后的又一个 LTS 版本，该版本引入了 Record class、Sealed Classes 以及 Pattern Matching for switch 等新特性。</p>
<p>对于一个曾经写过 Scala 的程序员来说最吸引人的自然就是 Pattern Matching 了</p>
<h2 id="瞧瞧隔壁家的孩子">瞧瞧隔壁家的孩子</h2>
<p>Pattern Matching 中文一般叫做模式匹配，它其实并不是什么新的概念，C#、Scala、Hashkell 等其他语言在很早以前就支持了。</p>
<p>简单来说，Pattern Matching 就是检查某个值是否匹配某一个模式的机制。这里的模式含义很广：可以是类型模式，可以是结构模式，也可以是常量模式。</p>
<p>鉴于 Scala 与 Java 的血缘关系，咱们以 Scala 为例来展示以下模式匹配的大概模样。</p>
<p>将下面的需求用 Pattern Matching 来实现：</p>
<p>我现在有一个 Shape 类，它有  X 和 Y 两个成员属性</p>
<ul>
<li>如果 X 和 Y 的值都是 1，那么输出 small</li>
<li>如果 X 和 Y 的值都是 5，那么输出 normal</li>
<li>否则输出 invalid</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#a90d91">case</span> <span style="color:#a90d91">class</span> <span style="color:#3f6e75">Shape</span><span style="color:#000">(</span><span style="color:#000">x</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Int</span><span style="color:#000">,</span> <span style="color:#000">y</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Int</span><span style="color:#000">);</span>

<span style="color:#a90d91">def</span> <span style="color:#000">testPatternMatching2</span><span style="color:#000">(</span><span style="color:#000">shape</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Shape</span><span style="color:#000">)</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Unit</span> <span style="color:#000">=</span> <span style="color:#000">{</span>
  <span style="color:#000">shape</span> <span style="color:#a90d91">match</span> <span style="color:#000">{</span>
		<span style="color:#177500">// shape 对象的 x 和 y 的值是否都为 1
</span><span style="color:#177500"></span>    <span style="color:#a90d91">case</span> <span style="color:#3f6e75">Shape</span><span style="color:#000">(</span><span style="color:#1c01ce">1</span><span style="color:#000">,</span> <span style="color:#1c01ce">1</span><span style="color:#000">)</span> <span style="color:#a90d91">=&gt;</span> <span style="color:#000">println</span><span style="color:#000">(</span><span style="color:#c41a16">&#34;small&#34;</span><span style="color:#000">)</span>
		<span style="color:#177500">// shape 对象的 x 和 y 的值是否都为 5
</span><span style="color:#177500"></span>    <span style="color:#a90d91">case</span> <span style="color:#3f6e75">Shape</span><span style="color:#000">(</span><span style="color:#1c01ce">5</span><span style="color:#000">,</span> <span style="color:#1c01ce">5</span><span style="color:#000">)</span> <span style="color:#a90d91">=&gt;</span> <span style="color:#000">println</span><span style="color:#000">(</span><span style="color:#c41a16">&#34;large&#34;</span><span style="color:#000">)</span>
    <span style="color:#a90d91">case</span> <span style="color:#a90d91">_</span> <span style="color:#a90d91">=&gt;</span> <span style="color:#000">println</span><span style="color:#000">(</span><span style="color:#c41a16">&#34;not support&#34;</span><span style="color:#000">)</span>
  <span style="color:#000">}</span>
<span style="color:#000">}</span>
</code></pre></div><p>上面的代码展示出了 Pattern Matching 的对象解构能力，它可以将 shape 对象结构以后与判断是否与指定的模式匹配。</p>
<p>再将上面的需求变一下：如果 shape 中的 x 与 y 相等就输出正方形，否则输出长方形。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#a90d91">case</span> <span style="color:#a90d91">class</span> <span style="color:#3f6e75">Shape</span><span style="color:#000">(</span><span style="color:#000">x</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Int</span><span style="color:#000">,</span> <span style="color:#000">y</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Int</span><span style="color:#000">);</span>

<span style="color:#a90d91">def</span> <span style="color:#000">testPatternMatching2</span><span style="color:#000">(</span><span style="color:#000">shape</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Shape</span><span style="color:#000">)</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Unit</span> <span style="color:#000">=</span> <span style="color:#000">{</span>
  <span style="color:#000">shape</span> <span style="color:#a90d91">match</span> <span style="color:#000">{</span>
	<span style="color:#177500">// 用 a 和 b 代替 Shape 类的成员变量 x 和 y
</span><span style="color:#177500"></span>    <span style="color:#a90d91">case</span> <span style="color:#3f6e75">Shape</span><span style="color:#000">(</span><span style="color:#000">a</span><span style="color:#000">,</span> <span style="color:#000">b</span><span style="color:#000">)</span> <span style="color:#a90d91">if</span> <span style="color:#000">a</span> <span style="color:#000">==</span> <span style="color:#000">b</span> <span style="color:#a90d91">=&gt;</span> <span style="color:#000">println</span><span style="color:#000">(</span><span style="color:#c41a16">&#34;正方形&#34;</span><span style="color:#000">)</span>
    <span style="color:#a90d91">case</span> <span style="color:#a90d91">_</span> <span style="color:#a90d91">=&gt;</span> <span style="color:#000">println</span><span style="color:#000">(</span><span style="color:#c41a16">&#34;长方形&#34;</span><span style="color:#000">)</span>
  <span style="color:#000">}</span>
<span style="color:#000">}</span>
</code></pre></div><p>是不是感受到了原来除了 if..else 代码还可以这样写？</p>
<p>下面我们开始进入 Pattern Matching in Java 吧</p>
<h2 id="他悄悄努力的样子">他悄悄努力的样子</h2>
<p>从 Java14 开始，Java 团队就在为引入 Pattern Matching 而努力了，他们并不想做得跟 Scala 完全一样，而是希望有过之而无不及。</p>
<p>由于现在 Java 更改了迭代和发布周期， Java 团队也采取了”小步快跑，快速迭代“的策略，最开始的 Pattern Matching 是针对 instanceof 操作符的强化，经历了三个版本，最终才正式在 Java16 中 Release</p>
<ul>
<li><a href="https://openjdk.java.net/jeps/305">JEP 305 Pattern Matching for instanceof (Preview)</a></li>
<li><a href="https://openjdk.java.net/jeps/375">JEP 375 Pattern Matching for instanceof (Second Preview)</a></li>
<li><a href="https://openjdk.java.net/jeps/394">JEP 394 Pattern Matching for instanceof</a></li>
</ul>
<p>Java 团队认为 ”switch 语句就是一种完美的模式匹配“，所以它们也为 switch 语句作了改进，并且随着 Java14 一起发布了</p>
<ul>
<li>
<p><a href="https://openjdk.java.net/jeps/354">JEP 354: Switch Expressions (Second Preview)</a></p>
</li>
<li>
<p><a href="https://openjdk.java.net/jeps/361">JEP 361: Switch Expressions</a></p>
</li>
</ul>
<p>然后才引入了 Pattern Matching for switch，该功能已经在 Java17 中作为预览特性发布了</p>
<ul>
<li><a href="https://openjdk.java.net/jeps/406">JEP 406: Pattern Matching for switch (Preview)</a></li>
</ul>
<p>还有最近处于候选状态的提案</p>
<ul>
<li><a href="https://openjdk.java.net/jeps/405">JEP 405: Record Patterns &amp; Array Patterns (Preview)</a></li>
</ul>
<p>总之，他在悄悄的努力。</p>
<p>铺垫了那么多，下面该进入演示环节了，看看 Java 中的 Pattern Matching 到底有何不同。</p>
<h2 id="小目标先加强个-instanceof">小目标：先加强个 instanceof</h2>
<p>instanceof 是 Java 中的一个二元操作符，作用是测试它左边的对象是否是它右边的类的实例，比如</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#177500">// obj 对象是否为 String 类型
</span><span style="color:#177500"></span><span style="color:#a90d91">public</span> <span style="color:#a90d91">static</span> <span style="color:#a90d91">boolean</span> <span style="color:#000">isString</span><span style="color:#000">(</span><span style="color:#000">Object</span> <span style="color:#000">obj</span><span style="color:#000">)</span> <span style="color:#000">{</span>
    <span style="color:#a90d91">return</span> <span style="color:#000">obj</span> <span style="color:#a90d91">instanceof</span> <span style="color:#000">String</span><span style="color:#000">;</span>
<span style="color:#000">}</span>
</code></pre></div><p>一般常用于类型强转之前的判断，避免  <code>ClassCastException</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a90d91">public</span> <span style="color:#a90d91">static</span> <span style="color:#a90d91">void</span> <span style="color:#000">testInstanceof</span><span style="color:#000">(</span><span style="color:#000">Object</span> <span style="color:#000">obj</span><span style="color:#000">)</span> <span style="color:#000">{</span>
    <span style="color:#a90d91">if</span> <span style="color:#000">(</span><span style="color:#000">obj</span> <span style="color:#a90d91">instanceof</span> <span style="color:#000">String</span><span style="color:#000">)</span> <span style="color:#000">{</span>
        <span style="color:#000">String</span> <span style="color:#000">str</span> <span style="color:#000">=</span> <span style="color:#000">(</span><span style="color:#000">String</span><span style="color:#000">)</span> <span style="color:#000">obj</span><span style="color:#000">;</span>
        <span style="color:#000">System</span><span style="color:#000">.</span><span style="color:#836c28">out</span><span style="color:#000">.</span><span style="color:#836c28">println</span><span style="color:#000">(</span><span style="color:#000">str</span><span style="color:#000">);</span>
    <span style="color:#000">}</span>
<span style="color:#000">}</span>
</code></pre></div><p>这种先判断再强转的代码让人感觉非常的乏味和重复，但它却充斥在几乎所有的 Java 项目中。</p>
<p>Java 团队很显然也意识到了这个问题，于是它们对 instanceof 操作符作了加强，使得 test and cast 可以合二为一，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a90d91">public</span> <span style="color:#a90d91">static</span> <span style="color:#a90d91">void</span> <span style="color:#000">testInstanceof</span><span style="color:#000">(</span><span style="color:#000">Object</span> <span style="color:#000">obj</span><span style="color:#000">)</span> <span style="color:#000">{</span>
    <span style="color:#a90d91">if</span> <span style="color:#000">(</span><span style="color:#000">obj</span> <span style="color:#a90d91">instanceof</span> <span style="color:#000">String</span> <span style="color:#000">str</span><span style="color:#000">)</span> <span style="color:#000">{</span>
        <span style="color:#000">System</span><span style="color:#000">.</span><span style="color:#836c28">out</span><span style="color:#000">.</span><span style="color:#836c28">println</span><span style="color:#000">(</span><span style="color:#000">str</span><span style="color:#000">);</span>
    <span style="color:#000">}</span>
<span style="color:#000">}</span>
</code></pre></div><p>不止如此，条件表达式支持守卫模式，即可以使用复杂的条件判断：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a90d91">public</span> <span style="color:#a90d91">static</span> <span style="color:#a90d91">boolean</span> <span style="color:#000">isLargerString</span><span style="color:#000">(</span><span style="color:#000">Object</span> <span style="color:#000">obj</span><span style="color:#000">)</span> <span style="color:#000">{</span>
    <span style="color:#a90d91">if</span> <span style="color:#000">(</span><span style="color:#000">obj</span> <span style="color:#a90d91">instanceof</span> <span style="color:#000">String</span> <span style="color:#000">str</span> <span style="color:#000">&amp;&amp;</span> <span style="color:#000">str</span><span style="color:#000">.</span><span style="color:#836c28">length</span><span style="color:#000">()</span> <span style="color:#000">&gt;</span> <span style="color:#000">68</span><span style="color:#000">)</span> <span style="color:#000">{</span>
        <span style="color:#a90d91">return</span> <span style="color:#a90d91">true</span><span style="color:#000">;</span>
    <span style="color:#000">}</span> <span style="color:#a90d91">else</span> <span style="color:#000">{</span>
        <span style="color:#a90d91">return</span> <span style="color:#a90d91">false</span><span style="color:#000">;</span>
    <span style="color:#000">}</span>
<span style="color:#000">}</span>
</code></pre></div><p>instanceof 现在在类型匹配的情况下，可以自动赋值为一个变量，后续代码就可以直接使用该变量进行操作了。</p>
<p>当然，现在的模式匹配与前面 Scala 展示的模式匹配还有很大的距离，不过起码 Java 是跨出去了这一步。</p>
<p>额外多说一句，类型模式匹配其实是模式匹配的一种特例，其他还有</p>
<ul>
<li>类型检测模式（将被转型的目标绑定到变量）</li>
<li>解构模式（解构目标并进行递归匹配）</li>
<li>常量模式（等值匹配，比如 Java 中的 switch 匹配字符串、枚举等）</li>
<li>变量模式（任意匹配并绑定目标）</li>
<li>下划线模式（任意匹配）</li>
</ul>
<p>好了，我们继续看看 Java 的 Pattern Matching for switch。</p>
<h2 id="再加强个-switch">再加强个 switch</h2>
<p>Pattern Matching for Switch 是 Java17 的预览特性，所以读者如果要运行以下代码的话至少需要安装 Java17，在编译时加上启用预览的参数才行（参考<a href="https://docs.oracle.com/en/java/javase/17/language/preview-language-and-vm-features.html">文档</a>）：</p>
<pre tabindex="0"><code class="language-curl" data-lang="curl">javac --enable-preview --release 17 Demo.java
</code></pre><p>如果你使用的是 Intellij IDEA，只需要将 Project 配置中的 Project language level 设置为 17(preview) 即可，如下图所示：</p>
<p><img src="img/idea-project-setting.png" alt="setting"></p>
<p>项目如果构建工具是 gradle 的话，最低版本需要 7.3-rc-1 才支持 Java17。</p>
<p>准备工作完成以后就可以体验 Java17 的 Pattern Matching for switch 了，不过这之前得先提一下 Java14 对 switch 得增强。</p>
<p>Java14 后得 switch 支持直接返回值，只需要使用 <code>-&gt;</code> 代替以前得 <code>:</code> 即可：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a90d91">public</span> <span style="color:#a90d91">static</span> <span style="color:#a90d91">void</span> <span style="color:#000">testSwitch</span><span style="color:#000">(</span><span style="color:#000">Integer</span> <span style="color:#000">num</span><span style="color:#000">)</span> <span style="color:#000">{</span>
    <span style="color:#000">String</span> <span style="color:#000">str</span> <span style="color:#000">=</span> <span style="color:#a90d91">switch</span> <span style="color:#000">(</span><span style="color:#000">num</span><span style="color:#000">)</span> <span style="color:#000">{</span>
        <span style="color:#a90d91">case</span> <span style="color:#000">1</span> <span style="color:#000">-&gt;</span> <span style="color:#c41a16">&#34;one&#34;</span><span style="color:#000">;</span>
        <span style="color:#a90d91">case</span> <span style="color:#000">2</span> <span style="color:#000">-&gt;</span> <span style="color:#c41a16">&#34;two&#34;</span><span style="color:#000">;</span>
        <span style="color:#a90d91">case</span> <span style="color:#000">3</span> <span style="color:#000">-&gt;</span> <span style="color:#c41a16">&#34;three&#34;</span><span style="color:#000">;</span>
        <span style="color:#a90d91">default</span> <span style="color:#000">-&gt;</span> <span style="color:#c41a16">&#34;unknown&#34;</span><span style="color:#000">;</span>
    <span style="color:#000">};</span>
<span style="color:#000">}</span>
</code></pre></div><p>也支持执函数表达式，不需要像以前一样匹配到以后还要手动 break，每个表达式被匹配执行以后就终止了</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a90d91">public</span> <span style="color:#a90d91">static</span> <span style="color:#a90d91">void</span> <span style="color:#000">testSwitch2</span><span style="color:#000">(</span><span style="color:#000">Integer</span> <span style="color:#000">num</span><span style="color:#000">)</span> <span style="color:#000">{</span>
    <span style="color:#a90d91">switch</span> <span style="color:#000">(</span><span style="color:#000">num</span><span style="color:#000">)</span> <span style="color:#000">{</span>
        <span style="color:#a90d91">case</span> <span style="color:#000">1</span> <span style="color:#000">-&gt;</span> <span style="color:#000">System</span><span style="color:#000">.</span><span style="color:#836c28">out</span><span style="color:#000">.</span><span style="color:#836c28">println</span><span style="color:#000">(</span><span style="color:#c41a16">&#34;one&#34;</span><span style="color:#000">);</span>
        <span style="color:#a90d91">case</span> <span style="color:#000">2</span> <span style="color:#000">-&gt;</span> <span style="color:#000">System</span><span style="color:#000">.</span><span style="color:#836c28">out</span><span style="color:#000">.</span><span style="color:#836c28">println</span><span style="color:#000">(</span><span style="color:#c41a16">&#34;two&#34;</span><span style="color:#000">);</span>
        <span style="color:#a90d91">case</span> <span style="color:#000">3</span> <span style="color:#000">-&gt;</span> <span style="color:#000">System</span><span style="color:#000">.</span><span style="color:#836c28">out</span><span style="color:#000">.</span><span style="color:#836c28">println</span><span style="color:#000">(</span><span style="color:#c41a16">&#34;three&#34;</span><span style="color:#000">);</span>
        <span style="color:#a90d91">default</span> <span style="color:#000">-&gt;</span> <span style="color:#000">System</span><span style="color:#000">.</span><span style="color:#836c28">out</span><span style="color:#000">.</span><span style="color:#836c28">println</span><span style="color:#000">(</span><span style="color:#c41a16">&#34;unknown&#34;</span><span style="color:#000">);</span>
    <span style="color:#000">}</span>
<span style="color:#000">}</span>
</code></pre></div><p>结合加强后得 switch 表达式，Java 团队将前面提到的类型匹配模式也应用在了 switch 上：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a90d91">public</span> <span style="color:#a90d91">static</span> <span style="color:#a90d91">void</span> <span style="color:#000">testSwitch3</span><span style="color:#000">(</span><span style="color:#000">Object</span> <span style="color:#000">obj</span><span style="color:#000">)</span> <span style="color:#000">{</span>
    <span style="color:#000">String</span> <span style="color:#000">formatted</span> <span style="color:#000">=</span> <span style="color:#a90d91">switch</span> <span style="color:#000">(</span><span style="color:#000">obj</span><span style="color:#000">)</span> <span style="color:#000">{</span>
        <span style="color:#a90d91">case</span> <span style="color:#000">Integer</span> <span style="color:#000">i</span> <span style="color:#000">-&gt;</span> <span style="color:#000">String</span><span style="color:#000">.</span><span style="color:#836c28">format</span><span style="color:#000">(</span><span style="color:#c41a16">&#34;int %d&#34;</span><span style="color:#000">,</span> <span style="color:#000">i</span><span style="color:#000">);</span>
        <span style="color:#a90d91">case</span> <span style="color:#000">Long</span> <span style="color:#000">l</span>    <span style="color:#000">-&gt;</span> <span style="color:#000">String</span><span style="color:#000">.</span><span style="color:#836c28">format</span><span style="color:#000">(</span><span style="color:#c41a16">&#34;long %d&#34;</span><span style="color:#000">,</span> <span style="color:#000">l</span><span style="color:#000">);</span>
        <span style="color:#a90d91">case</span> <span style="color:#000">Double</span> <span style="color:#000">d</span>  <span style="color:#000">-&gt;</span> <span style="color:#000">String</span><span style="color:#000">.</span><span style="color:#836c28">format</span><span style="color:#000">(</span><span style="color:#c41a16">&#34;double %f&#34;</span><span style="color:#000">,</span> <span style="color:#000">d</span><span style="color:#000">);</span>
        <span style="color:#a90d91">case</span> <span style="color:#000">String</span> <span style="color:#000">s</span>  <span style="color:#000">-&gt;</span> <span style="color:#000">String</span><span style="color:#000">.</span><span style="color:#836c28">format</span><span style="color:#000">(</span><span style="color:#c41a16">&#34;String %s&#34;</span><span style="color:#000">,</span> <span style="color:#000">s</span><span style="color:#000">);</span>
        <span style="color:#a90d91">default</span>        <span style="color:#000">-&gt;</span> <span style="color:#000">obj</span><span style="color:#000">.</span><span style="color:#836c28">toString</span><span style="color:#000">();</span>
    <span style="color:#000">};</span>
    <span style="color:#000">System</span><span style="color:#000">.</span><span style="color:#836c28">out</span><span style="color:#000">.</span><span style="color:#836c28">println</span><span style="color:#000">(</span><span style="color:#000">formatted</span><span style="color:#000">);</span>
<span style="color:#000">}</span>
</code></pre></div><p>当然，switch 的模式匹配也支持守卫模式</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a90d91">public</span> <span style="color:#a90d91">static</span> <span style="color:#a90d91">void</span> <span style="color:#000">testSwitch4</span><span style="color:#000">(</span><span style="color:#000">Object</span> <span style="color:#000">obj</span><span style="color:#000">)</span> <span style="color:#000">{</span>
    <span style="color:#000">String</span> <span style="color:#000">formatted</span> <span style="color:#000">=</span> <span style="color:#a90d91">switch</span> <span style="color:#000">(</span><span style="color:#000">obj</span><span style="color:#000">)</span> <span style="color:#000">{</span>
        <span style="color:#a90d91">case</span> <span style="color:#a90d91">null</span> <span style="color:#000">-&gt;</span> <span style="color:#c41a16">&#34;null&#34;</span><span style="color:#000">;</span>
        <span style="color:#a90d91">case</span> <span style="color:#000">String</span> <span style="color:#000">str</span> <span style="color:#000">&amp;&amp;</span> <span style="color:#000">str</span><span style="color:#000">.</span><span style="color:#836c28">length</span><span style="color:#000">()</span> <span style="color:#000">&gt;</span> <span style="color:#000">64</span> <span style="color:#000">-&gt;</span> <span style="color:#c41a16">&#34;long string&#34;</span><span style="color:#000">;</span>
        <span style="color:#a90d91">case</span> <span style="color:#000">String</span> <span style="color:#000">str</span> <span style="color:#000">-&gt;</span> <span style="color:#c41a16">&#34;normal string&#34;</span><span style="color:#000">;</span>
        <span style="color:#a90d91">default</span>        <span style="color:#000">-&gt;</span> <span style="color:#000">obj</span><span style="color:#000">.</span><span style="color:#836c28">toString</span><span style="color:#000">();</span>
    <span style="color:#000">};</span>
    <span style="color:#000">System</span><span style="color:#000">.</span><span style="color:#836c28">out</span><span style="color:#000">.</span><span style="color:#836c28">println</span><span style="color:#000">(</span><span style="color:#000">formatted</span><span style="color:#000">);</span>
<span style="color:#000">}</span>
</code></pre></div><p>是不是已经感觉有点前面 Scala 的影子了？</p>
<p>不过目前就到此为止了，对于前面提到的对象解构模式只能在未来的版本中去实现了&hellip;&hellip;</p>
<h2 id="下一步records-pattern-和-array-pattern">下一步：Records Pattern 和 Array Pattern</h2>
<p>Record Patterns &amp; Array Patterns 是 <a href="https://openjdk.java.net/jeps/405">JEP 405</a> 的提案内容，目标就是使得 Pattern Matching 可以应用于 Record class 和数组类型上。</p>
<blockquote>
<p>Records 是 Java16 发布的一种新的数据类型，详情查看<a href="https://openjdk.java.net/jeps/395"> JEP 395</a></p>
</blockquote>
<p>该提案主要就是实现对 Records 类型和 Array 类型的解构模式匹配，比如对于 Records 就可以使用如下的模式进行匹配</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a90d91">public</span> <span style="color:#000">record</span> <span style="color:#000">Point</span><span style="color:#000">(</span><span style="color:#a90d91">int</span> <span style="color:#000">x</span><span style="color:#000">,</span> <span style="color:#a90d91">int</span> <span style="color:#000">y</span><span style="color:#000">)</span> <span style="color:#000">{}</span>

<span style="color:#a90d91">public</span> <span style="color:#000">record</span> <span style="color:#000">3DPoint</span><span style="color:#000">(</span><span style="color:#a90d91">int</span> <span style="color:#000">x</span><span style="color:#000">,</span> <span style="color:#000">Point</span> <span style="color:#000">point</span><span style="color:#000">)</span> <span style="color:#000">{}</span>

<span style="color:#177500">/**
</span><span style="color:#177500">* 伪代码
</span><span style="color:#177500">*/</span>
<span style="color:#a90d91">public</span> <span style="color:#a90d91">static</span> <span style="color:#a90d91">void</span> <span style="color:#000">testMatch</span><span style="color:#000">(</span><span style="color:#000">Point</span> <span style="color:#000">point</span><span style="color:#000">,</span> <span style="color:#000">3DPoint</span> <span style="color:#000">3dPoint</span><span style="color:#000">)</span> <span style="color:#000">{</span>
    <span style="color:#177500">// 简单解构模式匹配
</span><span style="color:#177500"></span>    <span style="color:#a90d91">if</span> <span style="color:#000">(</span><span style="color:#000">point</span> <span style="color:#a90d91">instanceof</span> <span style="color:#000">Point</span><span style="color:#000">(</span><span style="color:#a90d91">int</span> <span style="color:#000">x</span><span style="color:#000">,</span> <span style="color:#a90d91">int</span> <span style="color:#000">y</span><span style="color:#000">)</span> <span style="color:#000">point</span><span style="color:#000">)</span> <span style="color:#000">{</span>
        <span style="color:#000">System</span><span style="color:#000">.</span><span style="color:#836c28">out</span><span style="color:#000">.</span><span style="color:#836c28">println</span><span style="color:#000">(</span><span style="color:#000">point</span><span style="color:#000">);</span>
    <span style="color:#000">}</span>
    
    <span style="color:#177500">// 嵌套解构模式匹配
</span><span style="color:#177500"></span>    <span style="color:#a90d91">if</span> <span style="color:#000">(</span><span style="color:#000">3dPoint</span> <span style="color:#a90d91">instanceof</span> <span style="color:#000">3DPoint</span><span style="color:#000">(</span><span style="color:#a90d91">int</span> <span style="color:#000">x</span><span style="color:#000">,</span> <span style="color:#000">Point</span><span style="color:#000">(</span><span style="color:#a90d91">int</span> <span style="color:#000">z</span><span style="color:#000">,</span> <span style="color:#a90d91">int</span> <span style="color:#000">y</span><span style="color:#000">)</span> <span style="color:#000">point</span><span style="color:#000">))</span> <span style="color:#000">{</span>
        <span style="color:#000">System</span><span style="color:#000">.</span><span style="color:#836c28">out</span><span style="color:#000">.</span><span style="color:#836c28">println</span><span style="color:#000">(</span><span style="color:#000">x</span><span style="color:#000">);</span>
        <span style="color:#000">System</span><span style="color:#000">.</span><span style="color:#836c28">out</span><span style="color:#000">.</span><span style="color:#836c28">println</span><span style="color:#000">(</span><span style="color:#000">point</span><span style="color:#000">);</span>
    <span style="color:#000">}</span>
<span style="color:#000">}</span>
</code></pre></div><p>由于该提案尚且处于 Candidate 的状态，本文就不多做介绍了，因为最终的实现可能于该提案有很大的不同。</p>
<p>不过呢我相信解构模式匹配 Java 一定是会实现的，甚至会比以往接触到的 Scala 模式匹配更强大也说不定。</p>
<h2 id="参考">参考</h2>
<ol>
<li><a href="https://en.wikipedia.org/wiki/Pattern_matching">Pattern Matching</a></li>
<li><a href="https://www.infoq.cn/article/2017/10/pattern-matching-for-java">《与 Brian Goetz 聊 Java 的模式匹配》</a></li>
<li><a href="https://docs.scala-lang.org/zh-cn/tour/pattern-matching.html">Scala docs：模式匹配</a></li>
<li><a href="http://ifeve.com/pattern-matching-1/">话说模式匹配(1) 什么是模式?</a></li>
</ol>

            </section>

            <div class="over">
                <div class="line"></div>
                <span>over</span>
                <div class="line"></div>
            </div>
        </article>
        <div class = "social">

    
        <a href="https://github.com/vran-dev">
            <svg t="1612751476854" class="social-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="9196" width="22" height="22">
                <path d="M63.681087 516.285293c0 210.288698 144.593659 387.06044 340.109608 435.411104 8.963443 2.334559 18.979018-5.66029 18.685506-14.948855V740.533933c0-9.954615 5.899616-19.5096 16.818309-25.228593 11.097059-5.5474 8.380932-25.607902-3.738907-28.030515-56.790299-11.356705-105.233532-34.160427-139.233656-64.471315-33.930132-30.367333-53.245562-67.216792-53.245561-106.518217 0-27.359951 9.783022-53.611324 27.084499-77.566521a14.623733 14.623733 0 0 0 2.817728-8.365127v-142.999656l118.721594 63.536587c3.619244 1.971054 8.143864 2.291661 12.088231 0.889571 33.284403-9.868819 69.433946-14.890153 108.385412-14.890153 38.949208 0 75.096494 5.021334 108.385413 14.948856a15.36429 15.36429 0 0 0 12.146933-0.891829l118.662892-63.59529v142.91386a15.115932 15.115932 0 0 0 2.801922 8.42383c17.346633 23.925846 27.098046 50.235922 27.098047 77.564263 0 39.333033-19.268016 76.180235-53.200406 106.547568-34.043022 30.310888-82.5427 53.083-139.278811 64.471315-12.115324 2.363911-14.77049 22.42667-3.73665 27.971813 10.923209 5.723508 16.822825 15.240111 16.822825 25.23085v196.215867c-0.295771 9.28405 9.749156 17.281157 18.685505 14.948855C816.104564 903.343476 960.668872 726.517546 960.668872 516.285293c0-247.50392-201.00239-448.495021-448.492764-448.495021-247.50392 0-448.495021 200.991101-448.495021 448.495021z m448.495021-418.595052c231.37198 0 418.590537 187.236619 418.590537 418.595052 0 189.266376-126.779662 345.246091-298.995176 397.046664v-172.800282c0-11.970825-4.610416-22.60052-11.209949-31.769422 49.723403-13.666429 95.127645-35.156114 127.946942-64.471315 38.922115-34.600697 62.660564-78.952807 62.660564-128.005645 0-32.381285-11.794717-62.003545-29.897711-88.808078v-165.336015c0.085796-10.469392-13.314213-18.322-22.428928-13.068113l-137.34614 73.755365c-34.108498-9.254699-70.578648-15.840684-109.320139-15.840685-38.718913 0-75.277118 6.525025-109.322397 15.840685l-137.352913-73.726013c-9.094395-5.253887-22.510209 2.598721-22.424412 13.068113v165.336014c-18.116541 26.806791-29.899969 56.429051-29.899969 88.808079 0 49.025744 23.7678 93.375596 62.617665 127.978551 32.878 29.373903 78.32514 50.804886 127.962747 64.532275-6.572439 9.137293-11.185113 19.737637-11.185113 31.737813v50.482022c-32.584486 12.149191-54.015469 14.718561-67.275495 12.149191-14.291838-2.829016-21.999947-10.189425-30.787282-22.426671-17.70788-24.646082-35.083865-69.989364-92.546986-84.820814-19.547983-5.222278-26.161062 23.912299-7.475557 28.996852 45.081378 11.67957 53.972571 43.329329 75.638365 73.579256 10.889342 15.068519 26.497473 29.084905 49.578904 33.636619 19.227376 3.736649 42.498461 0.878282 72.863535-9.372104v90.600767c-172.156811-51.825409-298.995176-207.834475-298.995175-397.100851 0.009031-231.360691 187.24565-418.59731 418.604083-418.59731z" fill="#707070" p-id="9197"></path>
            </svg>  
        </a>
    

    
        <a href='#'>
            <svg t="1612751098681" class="social-icon" viewBox="0 0 1026 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="16516" width="22" height="22">
                <path d="M512.034307 0C229.72222 0 0.002375 229.655981 0.002375 512S229.72222 1024 512.034307 1024 1024.066239 794.344019 1024.066239 512 794.346394 0 512.034307 0z m0 989.89647C248.530253 989.89647 34.169769 775.504054 34.169769 512S248.530253 34.10353 512.034307 34.10353 989.898845 248.495946 989.898845 512 775.538361 989.89647 512.034307 989.89647z" fill="#828282" p-id="16517"></path><path d="M792.845583 353.808158a119.106898 119.106898 0 0 0 8.717476-20.532369 17.083697 17.083697 0 0 0-24.939005-19.893726 192.646626 192.646626 0 0 1-52.560309 21.490333 122.332044 122.332044 0 0 0-81.810154-31.517026 121.980791 121.980791 0 0 0-121.789198 126.866409 281.673444 281.673444 0 0 1-183.130847-101.480355 17.115629 17.115629 0 0 0-27.972558 2.235251 121.757266 121.757266 0 0 0-2.107522 118.819508 20.053387 20.053387 0 0 0-6.833478 2.490707 18.233254 18.233254 0 0 0-8.430087 15.359362c0 36.242984 16.125733 69.516278 42.118499 92.124236l-1.117625 1.117625a17.051765 17.051765 0 0 0-3.448672 16.54085 121.853062 121.853062 0 0 0 69.739803 75.519521 195.871772 195.871772 0 0 1-108.760883 18.488712 17.403019 17.403019 0 0 0-18.073594 11.240115 17.115629 17.115629 0 0 0 6.865411 20.117251 314.244231 314.244231 0 0 0 169.847075 49.782212c197.340651 0 315.297992-160.299364 315.297992-315.266059l-0.031932-5.236872a227.420731 227.420731 0 0 0 49.207434-53.007359 17.083697 17.083697 0 0 0-20.787826-25.258326z m-55.721591 56.040913a17.083697 17.083697 0 0 0-7.088936 14.720718c0.191593 4.215043 0.287389 8.49395 0.287389 12.708994 0 138.20232-105.152551 281.16253-281.130598 281.162529a279.725583 279.725583 0 0 1-92.1881-15.582886 225.856056 225.856056 0 0 0 97.233379-44.385681 17.083697 17.083697 0 0 0-10.218286-30.495197 87.877261 87.877261 0 0 1-70.059124-37.105152c8.078832-0.542846 15.998004-1.883997 23.693651-3.959586a17.051765 17.051765 0 0 0-1.149558-33.20943 87.526007 87.526007 0 0 1-66.450792-60.830734c8.49395 2.139454 17.211426 3.384807 25.928901 3.672196 7.504054-0.031932 14.465261-4.630161 16.796308-11.846825s-0.415118-15.167768-6.769614-19.382812a87.685668 87.685668 0 0 1-36.498441-94.040164 315.585381 315.585381 0 0 0 209.730323 94.902332c5.620057 0.031932 10.537608-1.979793 13.954347-6.099039s4.725957-9.579643 3.512536-14.816515a87.813397 87.813397 0 0 1 149.506299-80.021954 17.083697 17.083697 0 0 0 15.774479 5.077211c5.268804-1.053761 10.473743-2.267182 15.614819-3.672196a81.043782 81.043782 0 0 1-7.216665 4.821753 17.083697 17.083697 0 0 0 10.793065 31.548959l5.81165-0.734439a178.979668 178.979668 0 0 1-9.867032 7.567918z" fill="#828282" p-id="16518"></path>
            </svg>
        </a>
    

    
        <a href='#' >
            <svg t="1612751005803" class="social-icon" viewBox="0 0 1026 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="13371" width="22" height="22">
                <path d="M512.034307 0C229.72222 0 0.002375 229.655981 0.002375 512S229.72222 1024 512.034307 1024 1024.066239 794.344019 1024.066239 512 794.346394 0 512.034307 0z m0 989.89647C248.530253 989.89647 34.169769 775.504054 34.169769 512S248.530253 34.10353 512.034307 34.10353 989.898845 248.495946 989.898845 512 775.538361 989.89647 512.034307 989.89647z" fill="#828282" p-id="13372"></path><path d="M623.796812 224.610702h-85.194961C430.096425 223.525009 416.237875 290.678309 416.237875 363.355869V416.203567h-47.898217a14.209804 14.209804 0 0 0-15.966072 15.966073v95.796432a14.209804 14.209804 0 0 0 15.966072 15.966072H416.237875v239.491082a14.337533 14.337533 0 0 0 16.061868 15.966072h97.552701c9.419983 1.085693 17.051765-6.54609 14.050143-15.966072L543.966451 543.932144h79.830361a14.209804 14.209804 0 0 0 15.966072-15.966072v-95.796432a14.209804 14.209804 0 0 0-15.966072-15.966073h-79.926157L543.966451 368.305351c3.097418-20.40464 3.097418-17.083697 22.03318-15.966072h57.126606c4.438568-0.989896 9.164525-0.44705 12.485468-3.672197 3.320943-3.225147 5.236872-7.631782 4.119247-12.293875v-95.796433A14.177872 14.177872 0 0 0 623.796812 224.610702z m-17.083697 94.008233l-40.042909-1.532743c-49.59062 0-53.741799 26.918798-53.741799 54.476238l-0.127728 60.543345a17.051765 17.051765 0 0 0 17.051765 17.083697H607.83074v61.692903h-77.914432a17.083697 17.083697 0 0 0-17.083697 17.051765L512.800679 767.457154H448.170019v-239.491082c0-9.419983-6.418361-17.051765-15.870276-17.051765H384.30573v-61.692902h47.994013a17.051765 17.051765 0 0 0 12.070351-4.981415c3.193214-3.225147 3.767993-7.567918 3.767993-12.102283v-68.81377c0-71.591867 14.465261-105.695397 90.431832-105.695398h68.111263v60.990396z" fill="#828282" p-id="13373"></path>
            </svg>
        </a>
    

    

</div>
        
        
        <div>
            <script src="https://utteranc.es/client.js"
repo='vran-dev/vran-dev.github.io'
issue-term="pathname"
label="Comment"
theme="github-light"
crossorigin="anonymous"
async>

</script>
        </div>
        

    </section>

    <footer id="footer">
    <p>
        
        © 2021 <i></i> vran
        
        ∘ Powered by <a href="http://www.gohugo.io/">Hugo</a>  ∘  Theme <a href="https://github.com/vran-dev/hugo-zenHo">ZenHo</a>
    </p>
</footer>


<script>
    var token = 'bacd84bd97ed2e6eef56ec4cae65acdb';
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?" + token;
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
    })();
</script>


</body>
